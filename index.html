<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>NeuroRecall | Smart Study Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-cpp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markdown.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #0f172a; color: #f8fafc; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .option-card { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .option-card:hover:not(.disabled) { transform: translateX(8px); border-color: #38bdf8; background: rgba(56, 189, 248, 0.1); }
        .option-card.selected-correct { background: rgba(52, 211, 153, 0.15); border-color: #34d399; color: #34d399; }
        .option-card.selected-wrong { background: rgba(251, 113, 133, 0.15); border-color: #fb7185; color: #fb7185; }
        .option-card.selected-partial { background: rgba(250, 204, 21, 0.15); border-color: #facc15; color: #facc15; }
        .option-card.user-selected { box-shadow: 0 0 0 2px currentColor; }
        .difficulty-btn { transition: transform 0.1s; }
        .difficulty-btn:active { transform: scale(0.95); }
        .flashcard-container { perspective: 1000px; }
        .flashcard { transition: transform 0.6s; transform-style: preserve-3d; }
        .flashcard.flipped { transform: rotateY(180deg); }
        .flashcard-face { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        .flashcard-back { transform: rotateY(180deg); }
        code { background: #1e293b; padding: 2px 6px; border-radius: 4px; color: #facc15; font-family: 'JetBrains Mono', monospace; font-size: 0.9em; border: 1px solid #334155; }
        pre { background: #0f172a; padding: 16px; border-radius: 8px; border: 1px solid #334155; overflow-x: auto; margin: 1rem 0; }
        pre code { background: transparent; padding: 0; border: none; color: inherit; }
        pre[class*="language-"] { background: #0f172a !important; border: 1px solid #334155; border-radius: 8px; margin: 1rem 0; }
        code[class*="language-"] { background: transparent !important; text-shadow: none !important; }
        :not(pre) > code { background: #1e293b; color: #facc15; padding: 2px 6px; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.9em; border: 1px solid #334155; }
        .custom-input { background: #0f172a; border: 1px solid #334155; color: white; padding: 0.75rem; border-radius: 0.5rem; width: 100%; transition: all 0.2s; }
        .custom-input:focus { outline: none; border-color: #38bdf8; box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.2); }
        .drop-zone { border: 2px dashed #334155; transition: all 0.3s ease; }
        .drop-zone.drag-over { border-color: #38bdf8; background: rgba(56, 189, 248, 0.1); transform: scale(1.02); }
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 16px 24px; border-radius: 12px; color: white; font-weight: 500; z-index: 100; transform: translateY(100px); opacity: 0; transition: all 0.3s ease; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: linear-gradient(135deg, #10b981, #059669); }
        .toast.error { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .toast.info { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .remote-badge { background: linear-gradient(135deg, #8b5cf6, #6366f1); }
        .multiselect-indicator { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .flashcard-indicator { background: linear-gradient(135deg, #ec4899, #db2777); }
        .github-file-item { transition: all 0.2s ease; }
        .github-file-item:hover { background: rgba(56, 189, 248, 0.1); }
        .github-file-item.selected { background: rgba(56, 189, 248, 0.2); border-color: #38bdf8; }
        .question-text code { white-space: pre-wrap; word-break: break-word; }
        .guide-section { background: linear-gradient(135deg, rgba(56, 189, 248, 0.1), rgba(139, 92, 246, 0.1)); border: 1px solid rgba(56, 189, 248, 0.2); }
        .copy-btn { transition: all 0.2s; }
        .copy-btn:hover { background: rgba(255,255,255,0.1); }
        .copy-btn.copied { background: rgba(52, 211, 153, 0.2); color: #34d399; }
        .stat-card { background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(255, 255, 255, 0.05); }
        @keyframes fadeIn { 0% { opacity: 0; } 100% { opacity: 1; } }
        @keyframes slideUp { 0% { transform: translateY(20px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .animate-slide-up { animation: slideUp 0.5s ease-out; }
    </style>
<base target="_blank">
</head>
<body class="min-h-screen flex flex-col font-sans antialiased selection:bg-purple-500 selection:text-white">
    <div class="fixed inset-0 z-0 pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-cyan-400/10 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-purple-400/10 rounded-full blur-[120px]"></div>
    </div>
    <div id="toast-container"></div>
    <nav class="relative z-10 w-full px-6 py-4 flex justify-between items-center border-b border-white/5 glass-panel">
        <div class="flex items-center gap-3 cursor-pointer" onclick="showHome()">
            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-cyan-400 to-purple-500 flex items-center justify-center shadow-lg shadow-cyan-400/20">
                <i class="fa-solid fa-bolt text-white text-sm"></i>
            </div>
            <span class="text-xl font-bold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">NeuroRecall</span>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="showGuide()" class="text-slate-400 hover:text-white transition-colors text-sm font-medium"><i class="fa-solid fa-wand-magic-sparkles mr-1"></i> AI Guide</button>
            <button onclick="showStats()" class="text-slate-400 hover:text-white transition-colors text-sm font-medium"><i class="fa-solid fa-chart-line mr-1"></i> Stats</button>
            <button onclick="showGitHubScanner()" class="text-slate-400 hover:text-white transition-colors text-sm font-medium"><i class="fa-brands fa-github mr-1"></i> Scan Repo</button>
            <button onclick="refreshRemoteDecks()" class="text-slate-400 hover:text-white transition-colors text-sm font-medium"><i class="fa-solid fa-rotate mr-1"></i> Sync</button>
            <button onclick="showManager()" class="text-slate-400 hover:text-white transition-colors text-sm font-medium"><i class="fa-solid fa-layer-group mr-1"></i> Decks</button>
        </div>
    </nav>
    <main class="relative z-10 flex-grow flex items-center justify-center p-4 md:p-8">
        <!-- VIEW: HOME -->
        <div id="view-home" class="w-full max-w-5xl animate-fade-in">
            <div class="text-center mb-12">
                <div class="mb-6 inline-flex items-center justify-center w-20 h-20 rounded-full bg-gradient-to-tr from-cyan-400 to-purple-500 shadow-2xl shadow-cyan-400/50">
                    <i class="fa-solid fa-brain text-4xl text-white"></i>
                </div>
                <h1 class="text-4xl md:text-6xl font-bold text-white mb-6 tracking-tight">Master Your <span class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-500">Memory</span></h1>
                <p class="text-slate-400 text-lg max-w-2xl mx-auto leading-relaxed">Active recall is the most effective way to learn. MCQs, flashcards, and everything in between.</p>
            </div>
            <div class="flex justify-center gap-4 mb-8 flex-wrap">
                <button onclick="showGitHubScanner()" class="glass-panel hover:bg-white/10 text-white px-6 py-3 rounded-xl transition-all border border-white/10 flex items-center gap-2"><i class="fa-brands fa-github text-xl"></i><span>Scan GitHub Repo</span></button>
                <button onclick="importFromGitHub()" class="glass-panel hover:bg-white/10 text-white px-6 py-3 rounded-xl transition-all border border-white/10 flex items-center gap-2"><i class="fa-solid fa-link text-xl"></i><span>Import from URL</span></button>
                <button onclick="showManager()" class="glass-panel hover:bg-white/10 text-white px-6 py-3 rounded-xl transition-all border border-white/10 flex items-center gap-2"><i class="fa-solid fa-folder-open text-xl"></i><span>Manage Decks</span></button>
                <button onclick="showGuide()" class="glass-panel hover:bg-white/10 text-white px-6 py-3 rounded-xl transition-all border border-white/10 flex items-center gap-2"><i class="fa-solid fa-book text-xl"></i><span>AI Guide</span></button>
            </div>
            <div id="remote-decks-section" class="hidden mb-8">
                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2"><i class="fa-solid fa-cloud text-cyan-400"></i> Cloud Decks</h3>
                <div id="remote-deck-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
            <div id="local-decks-section" class="mb-8">
                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2"><i class="fa-solid fa-hard-drive text-slate-500"></i> Local Decks</h3>
                <div id="deck-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
            <div class="mt-12 text-center">
                <button onclick="showSettings()" class="text-slate-500 hover:text-white text-sm underline mr-4">Configure Preset Decks</button>
                <button onclick="showManager()" class="text-slate-500 hover:text-white text-sm underline">Import / Export</button>
            </div>
        </div>
        <!-- VIEW: QUIZ -->
        <div id="view-quiz" class="w-full max-w-3xl hidden animate-fade-in">
            <button onclick="endSession()" class="mb-4 text-slate-400 hover:text-white flex items-center gap-2 text-sm"><i class="fa-solid fa-arrow-left"></i> Exit Session</button>
            <div class="flex justify-between items-end mb-4 px-2 text-sm font-mono text-slate-400">
                <div><span class="block text-xs uppercase tracking-wider opacity-50">Due</span><span id="stat-due" class="text-white font-bold text-lg">0</span></div>
                <div class="text-center"><span class="block text-xs uppercase tracking-wider opacity-50">Progress</span><span id="stat-progress" class="text-cyan-400">0/0</span></div>
                <div class="text-right"><span class="block text-xs uppercase tracking-wider opacity-50">Type</span><span id="stat-question-type" class="text-yellow-400">Single</span></div>
            </div>
            <div class="glass-panel rounded-2xl shadow-2xl overflow-hidden flex flex-col min-h-[500px]">
                <div class="flex-grow p-6 md:p-10 flex flex-col">
                    <div class="flex justify-between items-start mb-6">
                        <div class="flex items-center gap-2">
                            <span id="card-category" class="px-3 py-1 rounded-full text-xs font-bold bg-cyan-400/10 text-cyan-400 border border-cyan-400/20">General</span>
                            <span id="card-type-badge" class="hidden px-3 py-1 rounded-full text-xs font-bold bg-yellow-400/10 text-yellow-400 border border-yellow-400/20">MULTI-SELECT</span>
                        </div>
                        <span id="card-type" class="text-xs text-slate-500 font-mono">MULTIPLE CHOICE</span>
                    </div>
                    <div id="question-container" class="mb-6">
                        <h2 id="question-text" class="text-xl md:text-2xl font-semibold leading-relaxed text-slate-100 question-text">Loading question...</h2>
                    </div>
                    <p id="multiselect-hint" class="hidden text-sm text-yellow-400 mb-6 italic"><i class="fa-solid fa-circle-info mr-1"></i>Select all that apply. You must select all correct answers to be marked correct.</p>
                    <div id="code-block" class="hidden mb-6 relative group">
                        <div class="absolute top-2 right-2 text-xs text-slate-500 font-mono opacity-0 group-hover:opacity-100 transition-opacity">Code Snippet</div>
                        <pre><code id="code-content" class="language-java"></code></pre>
                    </div>
                    <div id="options-container" class="space-y-3"></div>
                    <div id="submit-container" class="hidden mt-6">
                        <button onclick="submitMultiSelect()" class="w-full bg-cyan-400 text-slate-900 font-bold py-3 rounded-xl hover:bg-cyan-300 transition-colors">Submit Answer</button>
                    </div>
                </div>
                <div id="explanation-area" class="hidden bg-slate-800/50 border-t border-white/5 p-6 md:p-10 animate-slide-up">
                    <div class="flex items-start gap-4">
                        <div id="feedback-icon" class="mt-1 text-2xl"><i class="fa-solid fa-circle-check text-emerald-400"></i></div>
                        <div>
                            <h3 id="feedback-title" class="text-lg font-bold text-white mb-2">Correct!</h3>
                            <div id="correct-answers-display" class="hidden mb-3 p-3 bg-slate-900 rounded-lg">
                                <span class="text-xs text-slate-400 uppercase font-bold">Correct Answers:</span>
                                <div id="correct-answers-list" class="text-emerald-400 mt-1"></div>
                            </div>
                            <p id="explanation-text" class="text-slate-300 leading-relaxed text-sm md:text-base">Explanation goes here.</p>
                        </div>
                    </div>
                </div>
                <div class="p-4 md:p-6 border-t border-white/5 bg-slate-900/50">
                    <div id="controls-initial" class="flex justify-between items-center">
                        <div class="text-xs text-slate-500 font-mono"><span id="initial-hint">Select an answer to reveal</span></div>
                        <button onclick="skipCard()" class="text-slate-400 hover:text-white text-sm font-semibold px-4 py-2 rounded-lg hover:bg-white/5 transition-colors">Skip <span class="hidden md:inline">(Next)</span></button>
                    </div>
                    <div id="controls-difficulty" class="hidden grid grid-cols-4 gap-3">
                        <button onclick="rateCard('again')" class="difficulty-btn flex flex-col items-center justify-center p-3 rounded-xl bg-red-500/10 border border-red-500/20 text-red-400 hover:bg-red-500/20"><span class="font-bold text-sm">Again</span><span class="text-[10px] opacity-70 mt-1">&lt; 1m</span></button>
                        <button onclick="rateCard('hard')" class="difficulty-btn flex flex-col items-center justify-center p-3 rounded-xl bg-orange-500/10 border border-orange-500/20 text-orange-400 hover:bg-orange-500/20"><span class="font-bold text-sm">Hard</span><span class="text-[10px] opacity-70 mt-1">2d</span></button>
                        <button onclick="rateCard('good')" class="difficulty-btn flex flex-col items-center justify-center p-3 rounded-xl bg-blue-500/10 border border-blue-500/20 text-blue-400 hover:bg-blue-500/20"><span class="font-bold text-sm">Good</span><span class="text-[10px] opacity-70 mt-1">4d</span></button>
                        <button onclick="rateCard('easy')" class="difficulty-btn flex flex-col items-center justify-center p-3 rounded-xl bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 hover:bg-emerald-500/20"><span class="font-bold text-sm">Easy</span><span class="text-[10px] opacity-70 mt-1">7d</span></button>
                    </div>
                </div>
            </div>
        </div>
        <!-- VIEW: FLASHCARD -->
        <div id="view-flashcard" class="w-full max-w-3xl hidden animate-fade-in">
            <button onclick="endFlashcardSession()" class="mb-4 text-slate-400 hover:text-white flex items-center gap-2 text-sm"><i class="fa-solid fa-arrow-left"></i> Exit Session</button>
            <div class="flex justify-between items-end mb-4 px-2 text-sm font-mono text-slate-400">
                <div><span class="block text-xs uppercase tracking-wider opacity-50">Due</span><span id="flash-stat-due" class="text-white font-bold text-lg">0</span></div>
                <div class="text-center"><span class="block text-xs uppercase tracking-wider opacity-50">Progress</span><span id="flash-stat-progress" class="text-pink-400">0/0</span></div>
                <div class="text-right"><span class="block text-xs uppercase tracking-wider opacity-50">Streak</span><span id="flash-stat-streak" class="text-yellow-400">0 ðŸ”¥</span></div>
            </div>
            <div class="flashcard-container h-[400px] mb-6">
                <div id="flashcard" class="flashcard relative w-full h-full cursor-pointer" onclick="flipFlashcard()">
                    <div class="flashcard-face absolute inset-0 glass-panel rounded-2xl p-8 flex flex-col items-center justify-center border-2 border-pink-400/30">
                        <span class="absolute top-4 right-4 text-xs text-pink-400 font-bold uppercase tracking-wider">Front</span>
                        <div id="flashcard-front-content" class="text-center w-full">
                            <h2 id="flashcard-question" class="text-2xl md:text-3xl font-bold text-white mb-4">Question</h2>
                            <div id="flashcard-code-front" class="hidden text-left w-full max-w-lg mx-auto"><pre><code id="flashcard-code-content-front" class="language-java"></code></pre></div>
                        </div>
                        <p class="absolute bottom-4 text-slate-500 text-sm animate-pulse">Click to flip</p>
                    </div>
                    <div class="flashcard-back flashcard-face absolute inset-0 glass-panel rounded-2xl p-8 flex flex-col items-center justify-center border-2 border-emerald-400/30">
                        <span class="absolute top-4 right-4 text-xs text-emerald-400 font-bold uppercase tracking-wider">Back</span>
                        <div id="flashcard-back-content" class="text-center w-full">
                            <h3 id="flashcard-answer" class="text-2xl md:text-3xl font-bold text-emerald-400 mb-4">Answer</h3>
                            <div id="flashcard-explanation" class="text-slate-300 text-lg mt-4"></div>
                            <div id="flashcard-code-back" class="hidden text-left w-full max-w-lg mx-auto mt-4"><pre><code id="flashcard-code-content-back" class="language-java"></code></pre></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="flashcard-controls" class="grid grid-cols-4 gap-3">
                <button onclick="rateFlashcard('again')" class="difficulty-btn flex flex-col items-center justify-center p-3 rounded-xl bg-red-500/10 border border-red-500/20 text-red-400 hover:bg-red-500/20"><span class="font-bold text-sm">Again</span><span class="text-[10px] opacity-70 mt-1">&lt; 1m</span></button>
                <button onclick="rateFlashcard('hard')" class="difficulty-btn flex flex-col items-center justify-center p-3 rounded-xl bg-orange-500/10 border border-orange-500/20 text-orange-400 hover:bg-orange-500/20"><span class="font-bold text-sm">Hard</span><span class="text-[10px] opacity-70 mt-1">2d</span></button>
                <button onclick="rateFlashcard('good')" class="difficulty-btn flex flex-col items-center justify-center p-3 rounded-xl bg-blue-500/10 border border-blue-500/20 text-blue-400 hover:bg-blue-500/20"><span class="font-bold text-sm">Good</span><span class="text-[10px] opacity-70 mt-1">4d</span></button>
                <button onclick="rateFlashcard('easy')" class="difficulty-btn flex flex-col items-center justify-center p-3 rounded-xl bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 hover:bg-emerald-500/20"><span class="font-bold text-sm">Easy</span><span class="text-[10px] opacity-70 mt-1">7d</span></button>
            </div>
        </div>
        <!-- VIEW: MANAGER -->
        <div id="view-manager" class="w-full max-w-6xl hidden animate-fade-in h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">Deck Manager</h2>
                <div class="flex gap-3">
                    <button onclick="showHome()" class="text-slate-400 hover:text-white px-4 py-2">Back</button>
                    <button onclick="createNewDeck()" class="bg-cyan-400 text-slate-900 font-bold px-4 py-2 rounded-lg hover:bg-cyan-300 transition-colors"><i class="fa-solid fa-plus mr-2"></i>New Deck</button>
                </div>
            </div>
            <div class="grid md:grid-cols-3 gap-4 mb-6">
                <div onclick="importFromGitHub()" class="glass-panel p-4 rounded-xl cursor-pointer hover:bg-white/5 transition-colors border border-white/10">
                    <div class="flex items-center gap-3 mb-2"><i class="fa-brands fa-github text-2xl text-white"></i><span class="font-bold text-white">GitHub URL</span></div>
                    <p class="text-xs text-slate-400">Import from raw GitHub URL</p>
                </div>
                <div onclick="triggerFileUpload()" class="glass-panel p-4 rounded-xl cursor-pointer hover:bg-white/5 transition-colors border border-white/10">
                    <div class="flex items-center gap-3 mb-2"><i class="fa-solid fa-file-arrow-up text-2xl text-cyan-400"></i><span class="font-bold text-white">Upload JSON</span></div>
                    <p class="text-xs text-slate-400">Import from local file</p>
                </div>
                <div onclick="showPresetConfig()" class="glass-panel p-4 rounded-xl cursor-pointer hover:bg-white/5 transition-colors border border-white/10">
                    <div class="flex items-center gap-3 mb-2"><i class="fa-solid fa-gear text-2xl text-purple-400"></i><span class="font-bold text-white">Auto-Sync</span></div>
                    <p class="text-xs text-slate-400">Configure preset remote decks</p>
                </div>
            </div>
            <div class="flex flex-col md:flex-row gap-6 h-full overflow-hidden">
                <div class="w-full md:w-1/3 glass-panel rounded-xl p-4 overflow-y-auto flex flex-col gap-2" id="manager-deck-list"></div>
                <div class="w-full md:w-2/3 glass-panel rounded-xl p-6 overflow-y-auto relative" id="manager-editor-panel">
                    <div id="editor-empty" class="h-full flex flex-col items-center justify-center text-slate-500">
                        <i class="fa-solid fa-folder-open text-4xl mb-4 opacity-50"></i>
                        <p>Select a deck to edit or view details</p>
                    </div>
                    <div id="editor-content" class="hidden">
                        <div class="flex justify-between items-start mb-6 border-b border-white/10 pb-4">
                            <div class="w-full mr-4">
                                <label class="text-xs text-slate-400 uppercase font-bold tracking-wider">Deck Name</label>
                                <input type="text" id="edit-deck-name" class="custom-input text-xl font-bold mt-1 bg-transparent border-none p-0 focus:ring-0" placeholder="Deck Name">
                            </div>
                            <div class="flex gap-2" id="deck-actions">
                                <button onclick="refreshCurrentDeck()" id="btn-refresh" class="hidden text-cyan-400 hover:text-white p-2" title="Refresh from Remote"><i class="fa-solid fa-rotate"></i></button>
                                <button onclick="deleteCurrentDeck()" class="text-red-400 hover:text-red-300 p-2" title="Delete Deck"><i class="fa-solid fa-trash"></i></button>
                                <button onclick="exportCurrentDeck()" class="text-slate-400 hover:text-white p-2" title="Export JSON"><i class="fa-solid fa-download"></i></button>
                            </div>
                        </div>
                        <div id="remote-info" class="hidden mb-4 p-3 bg-purple-400/10 border border-purple-400/20 rounded-lg">
                            <div class="flex items-center gap-2 text-sm text-purple-400">
                                <i class="fa-solid fa-cloud"></i>
                                <span>Remote Source:</span>
                                <a id="remote-url" href="#" target="_blank" class="underline truncate flex-grow"></a>
                                <span id="remote-status" class="text-xs px-2 py-1 rounded bg-purple-400/20">Synced</span>
                            </div>
                        </div>
                        <div id="local-upload" class="mb-6 hidden">
                            <label class="text-xs text-slate-400 uppercase font-bold tracking-wider mb-2 block">Import More Questions</label>
                            <div id="drop-zone" class="drop-zone rounded-xl p-4 text-center cursor-pointer">
                                <input type="file" id="file-input" accept=".json" multiple class="hidden" onclick="this.value=null">
                                <i class="fa-solid fa-cloud-arrow-up text-xl text-slate-400 mb-1"></i>
                                <p class="text-xs text-slate-400">Drop JSON files here or click to browse</p>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-white">Questions (<span id="edit-q-count">0</span>)</h3>
                            <div class="flex gap-2">
                                <button onclick="openQuestionModal()" class="text-xs bg-slate-700 hover:bg-slate-600 text-white px-3 py-1.5 rounded transition-colors"><i class="fa-solid fa-plus mr-1"></i> Add MCQ</button>
                                <button onclick="openFlashcardModal()" class="text-xs bg-pink-400/20 hover:bg-pink-400/30 text-pink-400 px-3 py-1.5 rounded transition-colors"><i class="fa-solid fa-layer-group mr-1"></i> Add Flashcard</button>
                            </div>
                        </div>
                        <div id="edit-questions-list" class="space-y-3"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- VIEW: GITHUB SCANNER -->
        <div id="view-github-scanner" class="w-full max-w-4xl hidden animate-fade-in">
            <div class="glass-panel rounded-2xl p-8">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-white">GitHub Repository Scanner</h2>
                        <p class="text-slate-400 text-sm mt-1">Scan any public GitHub repository for JSON question files</p>
                    </div>
                    <button onclick="showHome()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <div class="mb-6">
                    <label class="block text-xs text-slate-400 uppercase font-bold mb-2">Repository URL or owner/repo</label>
                    <div class="flex gap-2">
                        <input type="text" id="github-repo-input" class="custom-input flex-grow" placeholder="e.g., https://github.com/username/repo or username/repo">
                        <button onclick="scanGitHubRepo()" class="bg-cyan-400 text-slate-900 font-bold px-6 py-2 rounded-lg hover:bg-cyan-300 transition-colors whitespace-nowrap"><i class="fa-solid fa-magnifying-glass mr-2"></i>Scan</button>
                    </div>
                    <div class="mt-2 p-3 bg-cyan-400/10 border border-cyan-400/20 rounded-lg">
                        <p class="text-xs text-cyan-400"><i class="fa-solid fa-star mr-1"></i><strong>Default:</strong> whoopcat/Neuro-Recall</p>
                    </div>
                    <p class="text-xs text-slate-500 mt-2"><i class="fa-solid fa-circle-info mr-1"></i>Works with any public repository. No authentication required.</p>
                </div>
                <div id="scanner-loading" class="hidden text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-cyan-400 mb-4"></div>
                    <p class="text-slate-400">Scanning repository...</p>
                </div>
                <div id="scanner-results" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-white">Found JSON Files (<span id="scanner-count">0</span>)</h3>
                        <div class="flex gap-2">
                            <button onclick="selectAllScannerFiles(true)" class="text-xs text-cyan-400 hover:text-white">Select All</button>
                            <span class="text-slate-600">|</span>
                            <button onclick="selectAllScannerFiles(false)" class="text-xs text-slate-400 hover:text-white">None</button>
                        </div>
                    </div>
                    <div id="scanner-file-list" class="space-y-2 max-h-[400px] overflow-y-auto mb-6"></div>
                    <div class="flex justify-between items-center pt-4 border-t border-white/10">
                        <div class="text-sm text-slate-400"><span id="scanner-selected-count">0</span> files selected</div>
                        <div class="flex gap-3">
                            <button onclick="showHome()" class="px-4 py-2 text-slate-400 hover:text-white">Cancel</button>
                            <button onclick="importSelectedFiles()" class="bg-emerald-400 text-slate-900 font-bold px-6 py-2 rounded-lg hover:bg-emerald-300 transition-colors">Import Selected</button>
                        </div>
                    </div>
                </div>
                <div id="scanner-error" class="hidden text-center py-8">
                    <i class="fa-solid fa-circle-exclamation text-4xl text-red-400 mb-4"></i>
                    <p class="text-red-400 mb-2">Failed to scan repository</p>
                    <p class="text-slate-500 text-sm" id="scanner-error-msg">Make sure the repository exists and is public</p>
                    <button onclick="resetScanner()" class="mt-4 text-cyan-400 hover:text-white text-sm">Try Again</button>
                </div>
            </div>
        </div>
        <!-- VIEW: PRESET CONFIG -->
        <div id="view-preset-config" class="w-full max-w-2xl hidden animate-fade-in">
            <div class="glass-panel rounded-2xl p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-white">Preset Remote Decks</h2>
                    <button onclick="showHome()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <p class="text-slate-400 mb-6">Add URLs to JSON files that will auto-load on startup. Perfect for syncing with GitHub.</p>
                <div id="preset-list" class="space-y-3 mb-6"></div>
                <div class="flex gap-2 mb-6">
                    <input type="text" id="new-preset-name" class="custom-input flex-1" placeholder="Deck Name (e.g., Web Dev)">
                    <input type="text" id="new-preset-url" class="custom-input flex-2" placeholder="Raw GitHub URL...">
                    <button onclick="addPreset()" class="bg-cyan-400 text-slate-900 font-bold px-4 py-2 rounded-lg">Add</button>
                </div>
                <div class="p-4 bg-slate-800 rounded-lg border border-slate-700">
                    <h4 class="text-sm font-bold text-white mb-2">How to get the URL:</h4>
                    <ol class="text-xs text-slate-400 space-y-1 list-decimal list-inside">
                        <li>Upload your JSON to GitHub</li>
                        <li>Click on the file</li>
                        <li>Click <strong>Raw</strong> button</li>
                        <li>Copy that URL (starts with raw.githubusercontent.com)</li>
                    </ol>
                </div>
                <div class="mt-6 flex justify-end">
                    <button onclick="savePresetsAndLoad()" class="bg-emerald-400 text-slate-900 font-bold px-6 py-2 rounded-lg hover:bg-emerald-300">Save & Load Decks</button>
                </div>
            </div>
        </div>
        <!-- VIEW: GUIDE -->
        <div id="view-guide" class="w-full max-w-4xl hidden animate-fade-in">
            <div class="glass-panel rounded-2xl p-8 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-white">AI Generation Guide</h2>
                        <p class="text-slate-400 text-sm mt-1">Learn how to generate perfect study materials with AI</p>
                    </div>
                    <button onclick="showHome()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <div class="space-y-8">
                    <section class="guide-section rounded-xl p-6">
                        <h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2"><i class="fa-solid fa-rocket text-cyan-400"></i>Quick Start Prompt</h3>
                        <p class="text-slate-300 text-sm mb-4">Copy this prompt and paste it into ChatGPT, Claude, or any AI assistant:</p>
                        <div class="relative bg-slate-900 rounded-lg p-4 border border-slate-700">
                            <button onclick="copyToClipboard('quick-prompt')" class="copy-btn absolute top-2 right-2 p-2 rounded text-slate-400" title="Copy"><i class="fa-regular fa-copy"></i></button>
                            <pre id="quick-prompt" class="text-xs text-slate-300 whitespace-pre-wrap font-mono">Generate a JSON file for flashcards/mcq about [TOPIC]. Include:
- Mix of flashcards (term/definition) and MCQs (4 options, 1 correct)
- Code examples where relevant
- Explanations for answers
- Categories for organization

Format each item with: question, answer/options, explanation, category, type ("flashcard" or "mcq")</pre>
                        </div>
                    </section>
                    <section>
                        <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="fa-solid fa-code text-emerald-400"></i>JSON Format Reference</h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700">
                                <h4 class="text-sm font-bold text-yellow-400 mb-2">MCQ Format</h4>
                                <pre class="text-xs text-slate-300 overflow-x-auto"><code>{"question": "What is the time complexity?", "options": ["O(n)", "O(log n)", "O(nÂ²)"], "correct": 1, "explanation": "Binary search divides...", "category": "Algorithms", "type": "mcq"}</code></pre>
                            </div>
                            <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700">
                                <h4 class="text-sm font-bold text-pink-400 mb-2">Flashcard Format</h4>
                                <pre class="text-xs text-slate-300 overflow-x-auto"><code>{"question": "What is Big O notation?", "answer": "A mathematical notation...", "explanation": "Used to classify...", "category": "CS Fundamentals", "type": "flashcard"}</code></pre>
                            </div>
                        </div>
                    </section>
                    <section>
                        <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="fa-solid fa-lightbulb text-yellow-400"></i>Pro Tips for Better Cards</h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="space-y-3">
                                <div class="flex items-start gap-3"><i class="fa-solid fa-check text-emerald-400 mt-1"></i><div><h4 class="text-sm font-bold text-white">Use Code Blocks</h4><p class="text-xs text-slate-400">Wrap code in triple backticks for syntax highlighting</p></div></div>
                                <div class="flex items-start gap-3"><i class="fa-solid fa-check text-emerald-400 mt-1"></i><div><h4 class="text-sm font-bold text-white">Mix Question Types</h4><p class="text-xs text-slate-400">Combine MCQs for testing and flashcards for memorization</p></div></div>
                            </div>
                            <div class="space-y-3">
                                <div class="flex items-start gap-3"><i class="fa-solid fa-check text-emerald-400 mt-1"></i><div><h4 class="text-sm font-bold text-white">Add Categories</h4><p class="text-xs text-slate-400">Organize by topic for targeted study sessions</p></div></div>
                                <div class="flex items-start gap-3"><i class="fa-solid fa-check text-emerald-400 mt-1"></i><div><h4 class="text-sm font-bold text-white">Explain Wrong Answers</h4><p class="text-xs text-slate-400">Good explanations prevent future mistakes</p></div></div>
                            </div>
                        </div>
                    </section>
                    <section>
                        <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="fa-solid fa-book-open text-purple-400"></i>Example Prompts by Subject</h3>
                        <div class="space-y-3">
                            <details class="bg-slate-800/30 rounded-lg border border-slate-700">
                                <summary class="p-4 cursor-pointer text-sm font-bold text-white hover:bg-white/5 rounded-lg">Programming Interview Prep</summary>
                                <div class="p-4 pt-0 text-xs text-slate-300">
                                    <button onclick="copyText(this)" class="copy-btn float-right p-2 rounded text-slate-400" title="Copy"><i class="fa-regular fa-copy"></i></button>
                                    <pre class="whitespace-pre-wrap font-mono">Create 20 MCQs about data structures and algorithms for FAANG interviews. Include code snippets in Python. Cover: arrays, linked lists, trees, graphs, dynamic programming. Add detailed explanations for why answers are correct.</pre>
                                </div>
                            </details>
                            <details class="bg-slate-800/30 rounded-lg border border-slate-700">
                                <summary class="p-4 cursor-pointer text-sm font-bold text-white hover:bg-white/5 rounded-lg">Language Learning (Spanish)</summary>
                                <div class="p-4 pt-0 text-xs text-slate-300">
                                    <button onclick="copyText(this)" class="copy-btn float-right p-2 rounded text-slate-400" title="Copy"><i class="fa-regular fa-copy"></i></button>
                                    <pre class="whitespace-pre-wrap font-mono">Generate 30 Spanish vocabulary flashcards for travel. Include: common phrases, food terms, directions. Format as flashcards with Spanish term and English definition. Add pronunciation tips in explanation.</pre>
                                </div>
                            </details>
                            <details class="bg-slate-800/30 rounded-lg border border-slate-700">
                                <summary class="p-4 cursor-pointer text-sm font-bold text-white hover:bg-white/5 rounded-lg">Medical School (Anatomy)</summary>
                                <div class="p-4 pt-0 text-xs text-slate-300">
                                    <button onclick="copyText(this)" class="copy-btn float-right p-2 rounded text-slate-400" title="Copy"><i class="fa-regular fa-copy"></i></button>
                                    <pre class="whitespace-pre-wrap font-mono">Create 25 MCQs about human skeletal system. Include clinical scenarios. Mix question types: identification, function, and pathology. Use medical terminology.</pre>
                                </div>
                            </details>
                        </div>
                    </section>
                </div>
            </div>
        </div>
        <!-- VIEW: STATS -->
        <div id="view-stats" class="w-full max-w-4xl hidden animate-fade-in">
            <div class="glass-panel rounded-2xl p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-white">Study Statistics</h2>
                    <button onclick="showHome()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <div class="grid md:grid-cols-4 gap-4 mb-8">
                    <div class="stat-card rounded-xl p-4 text-center">
                        <div class="text-3xl font-bold text-cyan-400 mb-1" id="stat-total-cards">0</div>
                        <div class="text-xs text-slate-400 uppercase">Total Cards</div>
                    </div>
                    <div class="stat-card rounded-xl p-4 text-center">
                        <div class="text-3xl font-bold text-emerald-400 mb-1" id="stat-due-today">0</div>
                        <div class="text-xs text-slate-400 uppercase">Due Today</div>
                    </div>
                    <div class="stat-card rounded-xl p-4 text-center">
                        <div class="text-3xl font-bold text-yellow-400 mb-1" id="stat-studied-today">0</div>
                        <div class="text-xs text-slate-400 uppercase">Studied Today</div>
                    </div>
                    <div class="stat-card rounded-xl p-4 text-center">
                        <div class="text-3xl font-bold text-purple-400 mb-1" id="stat-current-streak">0</div>
                        <div class="text-xs text-slate-400 uppercase">Day Streak</div>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-slate-800/50 rounded-xl p-6 border border-slate-700">
                        <h3 class="text-lg font-bold text-white mb-4">Cards by Type</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center"><span class="text-slate-400">MCQs</span><span class="text-cyan-400 font-bold" id="stat-mcq-count">0</span></div>
                            <div class="w-full bg-slate-700 rounded-full h-2"><div id="stat-mcq-bar" class="bg-cyan-400 h-2 rounded-full" style="width: 0%"></div></div>
                            <div class="flex justify-between items-center mt-4"><span class="text-slate-400">Flashcards</span><span class="text-pink-400 font-bold" id="stat-flash-count">0</span></div>
                            <div class="w-full bg-slate-700 rounded-full h-2"><div id="stat-flash-bar" class="bg-pink-400 h-2 rounded-full" style="width: 0%"></div></div>
                        </div>
                    </div>
                    <div class="bg-slate-800/50 rounded-xl p-6 border border-slate-700">
                        <h3 class="text-lg font-bold text-white mb-4">Retention Rate</h3>
                        <div class="text-center">
                            <div class="text-5xl font-bold text-emerald-400 mb-2" id="stat-retention">0%</div>
                            <p class="text-sm text-slate-400">Cards rated "Good" or "Easy"</p>
                        </div>
                        <div class="mt-4 grid grid-cols-2 gap-4 text-center">
                            <div><div class="text-xl font-bold text-white" id="stat-mastered">0</div><div class="text-xs text-slate-500">Mastered</div></div>
                            <div><div class="text-xl font-bold text-white" id="stat-learning">0</div><div class="text-xs text-slate-500">Learning</div></div>
                        </div>
                    </div>
                </div>
                <div class="mt-6 bg-slate-800/50 rounded-xl p-6 border border-slate-700">
                    <h3 class="text-lg font-bold text-white mb-4">Study Activity (Last 7 Days)</h3>
                    <div class="flex items-end justify-between h-32 gap-2" id="activity-chart"></div>
                </div>
            </div>
        </div>
    </main>
    <!-- MODAL: ADD/EDIT QUESTION -->
    <div id="modal-question" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="glass-panel w-full max-w-2xl rounded-2xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white" id="modal-title">Add Question</h3>
                <button onclick="closeQuestionModal()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="space-y-4">
                <div><label class="block text-xs text-slate-400 uppercase font-bold mb-1">Question Text</label><textarea id="q-input-text" class="custom-input h-20" placeholder="Enter the question..."></textarea></div>
                <div><label class="block text-xs text-slate-400 uppercase font-bold mb-1">Category</label><input type="text" id="q-input-category" class="custom-input" placeholder="e.g., Algorithms, History"></div>
                <div><label class="block text-xs text-slate-400 uppercase font-bold mb-1">Question Type</label><select id="q-input-type" class="custom-input" onchange="toggleCorrectAnswerInput()"><option value="single">Single Select</option><option value="multiselect">Multi Select</option></select></div>
                <div><label class="block text-xs text-slate-400 uppercase font-bold mb-1">Code Snippet (Optional)</label><textarea id="q-input-code" class="custom-input h-24 font-mono text-xs" placeholder="Paste code here..."></textarea></div>
                <div>
                    <label class="block text-xs text-slate-400 uppercase font-bold mb-1">Options</label>
                    <div id="q-options-container" class="space-y-2"></div>
                    <button onclick="addOptionInput()" class="mt-2 text-xs text-cyan-400 hover:underline">+ Add Option</button>
                </div>
                <div>
                    <label class="block text-xs text-slate-400 uppercase font-bold mb-1" id="correct-answer-label">Correct Answer</label>
                    <div id="correct-single"><select id="q-input-correct" class="custom-input"></select></div>
                    <div id="correct-multi" class="hidden"><div id="multi-correct-checkboxes" class="space-y-2"></div></div>
                </div>
                <div><label class="block text-xs text-slate-400 uppercase font-bold mb-1">Explanation</label><textarea id="q-input-explanation" class="custom-input h-20" placeholder="Why is this the correct answer?"></textarea></div>
            </div>
            <div class="mt-8 flex justify-end gap-3">
                <button onclick="closeQuestionModal()" class="px-4 py-2 text-slate-400 hover:text-white">Cancel</button>
                <button onclick="saveQuestion()" class="bg-cyan-400 text-slate-900 font-bold px-6 py-2 rounded-lg hover:bg-cyan-300">Save Question</button>
            </div>
        </div>
    </div>
    <!-- MODAL: ADD/EDIT FLASHCARD -->
    <div id="modal-flashcard" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="glass-panel w-full max-w-2xl rounded-2xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white" id="flash-modal-title">Add Flashcard</h3>
                <button onclick="closeFlashcardModal()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="space-y-4">
                <div><label class="block text-xs text-slate-400 uppercase font-bold mb-1">Front (Question/Prompt)</label><textarea id="flash-input-front" class="custom-input h-24" placeholder="What is...?"></textarea></div>
                <div><label class="block text-xs text-slate-400 uppercase font-bold mb-1">Back (Answer)</label><textarea id="flash-input-back" class="custom-input h-24" placeholder="The answer is..."></textarea></div>
                <div><label class="block text-xs text-slate-400 uppercase font-bold mb-1">Category</label><input type="text" id="flash-input-category" class="custom-input" placeholder="e.g., Vocabulary, Definitions"></div>
                <div><label class="block text-xs text-slate-400 uppercase font-bold mb-1">Code Snippet - Front (Optional)</label><textarea id="flash-input-code-front" class="custom-input h-20 font-mono text-xs" placeholder="Code to show on front..."></textarea></div>
                <div><label class="block text-xs text-slate-400 uppercase font-bold mb-1">Code Snippet - Back (Optional)</label><textarea id="flash-input-code-back" class="custom-input h-20 font-mono text-xs" placeholder="Code to show on back..."></textarea></div>
                <div><label class="block text-xs text-slate-400 uppercase font-bold mb-1">Additional Notes/Explanation</label><textarea id="flash-input-explanation" class="custom-input h-20" placeholder="Extra context or explanation..."></textarea></div>
            </div>
            <div class="mt-8 flex justify-end gap-3">
                <button onclick="closeFlashcardModal()" class="px-4 py-2 text-slate-400 hover:text-white">Cancel</button>
                <button onclick="saveFlashcard()" class="bg-pink-400 text-white font-bold px-6 py-2 rounded-lg hover:bg-pink-300">Save Flashcard</button>
            </div>
        </div>
    </div>

    <script>
        const Storage = {
            get(key, defaultVal = null) {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultVal;
                } catch (e) {
                    console.error(`Error reading ${key}:`, e);
                    return defaultVal;
                }
            },
            set(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                } catch (e) {
                    if (e.name === 'QuotaExceededError' || e.code === 22 || e.code === 1014) {
                        showToast('Storage full! Export and clear decks first.', 'error');
                    } else {
                        showToast('Storage access denied. Check browser settings.', 'error');
                    }
                    return false;
                }
            },
            clear() {
                try {
                    localStorage.removeItem('neurorecall_decks');
                    localStorage.removeItem('neurorecall_presets');
                    localStorage.removeItem('neurorecall_stats');
                    return true;
                } catch (e) {
                    return false;
                }
            }
        };

        const SETTINGS = {
            again: 0.05, 
            hard: 2.0,
            good: 4.0,
            easy: 7.0,
            easeFactor: 2.5,
            easeBonus: 0.15
        };

        // Default repo constant
        const DEFAULT_REPO = 'whoopcat/Neuro-Recall';

        let decks = [];
        let presets = [];
        let activeDeckId = null;
        let sessionQueue = []; 
        let currentCardIndex = 0;
        let isAnswerRevealed = false;
        let editingQuestionIndex = null;
        let selectedManagerDeckId = null;
        let selectedOptions = new Set();
        let scannerFiles = [];
        let scannerRepoInfo = null;
        let flashcardQueue = [];
        let currentFlashcardIndex = 0;
        let currentStreak = 0;
        let studyStats = {
            studiedToday: 0,
            lastStudyDate: null,
            dailyActivity: {},
            totalReviews: 0,
            correctReviews: 0
        };

        window.onload = async () => {
            presets = Storage.get('neurorecall_presets', []);
            studyStats = Storage.get('neurorecall_stats', studyStats);

            // Check and update streak
            checkStreak();

            const savedDecks = Storage.get('neurorecall_decks', []);
            if (savedDecks && savedDecks.length > 0) {
                decks = savedDecks;
                decks.forEach(d => {
                    if (d.questions) {
                        d.questions.forEach(q => {
                            if(q.dueDate) q.dueDate = new Date(q.dueDate);
                            if (q.correctArray && q.correctArray.length > 1) {
                                q.isMultiselect = true;
                            }
                        });
                    }
                });
            } else {
                createDefaultDeck();
            }

            await loadPresetDecks();
            renderHome();
            setupDragAndDrop();
        };

        function checkStreak() {
            const today = new Date().toDateString();
            const lastDate = studyStats.lastStudyDate;

            if (lastDate) {
                const last = new Date(lastDate);
                const todayDate = new Date();
                const diffDays = Math.floor((todayDate - last) / (1000 * 60 * 60 * 24));

                if (diffDays === 1) {
                    // Continue streak
                } else if (diffDays > 1) {
                    // Reset streak
                    currentStreak = 0;
                }
            }

            // Reset daily count if new day
            if (lastDate !== today) {
                studyStats.studiedToday = 0;
            }
        }

        function updateStats(rating) {
            const today = new Date().toDateString();
            studyStats.lastStudyDate = today;
            studyStats.studiedToday++;
            studyStats.totalReviews++;

            if (rating === 'good' || rating === 'easy') {
                studyStats.correctReviews++;
            }

            // Track daily activity
            if (!studyStats.dailyActivity[today]) {
                studyStats.dailyActivity[today] = 0;
            }
            studyStats.dailyActivity[today]++;

            Storage.set('neurorecall_stats', studyStats);
        }

        function saveToStorage() {
            Storage.set('neurorecall_decks', decks);
            Storage.set('neurorecall_presets', presets);
            Storage.set('neurorecall_stats', studyStats);
        }

        function createDefaultDeck() {
            decks.push({
                id: Date.now().toString(),
                name: "Sample Deck",
                isLocal: true,
                questions: [
                    {
                        id: 'q1',
                        question: "Which of the following Big-O notations represents the most efficient time complexity?",
                        options: ["O(n^2)", "O(n)", "O(log n)", "O(n!)"],
                        correct: 2,
                        correctArray: [2],
                        isMultiselect: false,
                        type: 'mcq',
                        explanation: "O(log n) grows very slowly compared to input size.",
                        category: "Algorithms",
                        code: null,
                        dueDate: new Date(),
                        interval: 0,
                        ease: 2.5
                    },
                    {
                        id: 'q2',
                        question: "What is the primary purpose of a stack data structure?",
                        answer: "LIFO - Last In, First Out operations",
                        explanation: "Stacks follow LIFO principle where the last element added is the first one removed.",
                        category: "Data Structures",
                        type: 'flashcard',
                        dueDate: new Date(),
                        interval: 0,
                        ease: 2.5
                    }
                ]
            });
            saveToStorage();
        }

        function isMultiSelect(question) {
            return question.isMultiselect === true || Array.isArray(question.correct) || question.type === 'multiselect';
        }

        function normalizeCorrect(correct) {
            if (Array.isArray(correct)) return correct;
            if (typeof correct === 'number') return [correct];
            return [0];
        }

        function isFlashcard(question) {
            return question.type === 'flashcard' || (!question.options && question.answer);
        }

        function detectLanguage(code, category) {
            if (!code) return 'java';
            const lowerCode = code.toLowerCase();
            const lowerCat = (category || '').toLowerCase();

            if (lowerCode.includes('class ') && lowerCode.includes('public static void main')) return 'java';
            if (lowerCode.includes('system.out.println')) return 'java';
            if (lowerCode.includes('def ') && lowerCode.includes(':')) return 'python';
            if (lowerCode.includes('console.log') || lowerCode.includes('function') || lowerCode.includes('=>')) return 'javascript';
            if (lowerCode.includes('#include')) return 'c';
            if (lowerCode.includes('using namespace') || lowerCode.includes('std::')) return 'cpp';
            if (lowerCode.includes('<html') || lowerCode.includes('<div')) return 'html';
            if (lowerCode.includes('select ') && lowerCode.includes('from ')) return 'sql';

            if (lowerCat.includes('java')) return 'java';
            if (lowerCat.includes('python')) return 'python';
            if (lowerCat.includes('c++') || lowerCat.includes('cpp')) return 'cpp';
            if (lowerCat.includes('c ')) return 'c';
            if (lowerCat.includes('sql')) return 'sql';
            if (lowerCat.includes('web') || lowerCat.includes('html')) return 'html';
            if (lowerCat.includes('javascript') || lowerCat.includes('js')) return 'javascript';

            return 'java';
        }

        function formatQuestionText(text, codeField, category) {
            if (!text) return { text: '', code: codeField, language: 'java' };

            let code = codeField;
            const codeBlockRegex = /```(\w+)?\n?([\s\S]*?)```/g;
            const inlineCodeRegex = /`([^`]+)`/g;

            let formattedText = text;
            let extractedCode = null;
            let language = 'java';

            formattedText = formattedText.replace(codeBlockRegex, (match, lang, codeContent) => {
                if (!extractedCode) {
                    extractedCode = codeContent.trim();
                    language = lang || detectLanguage(codeContent, category);
                }
                return '';
            });

            formattedText = formattedText.replace(inlineCodeRegex, (match, codeContent) => {
                return `<code>${escapeHtml(codeContent)}</code>`;
            });

            formattedText = formattedText.replace(/\n{3,}/g, '\n\n').trim();

            if (extractedCode && !code) {
                code = extractedCode;
            }

            return { text: formattedText, code: code, language: language };
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // GitHub Scanner with default repo
        function showGitHubScanner() {
            hideAllViews();
            document.getElementById('view-github-scanner').classList.remove('hidden');
            resetScanner();

            // Set default repo
            const input = document.getElementById('github-repo-input');
            input.value = DEFAULT_REPO;

            const lastRepo = Storage.get('neurorecall_last_repo', '');
            if (lastRepo && lastRepo !== DEFAULT_REPO) {
                input.value = lastRepo;
            }
        }

        function resetScanner() {
            scannerFiles = [];
            scannerRepoInfo = null;
            document.getElementById('scanner-loading').classList.add('hidden');
            document.getElementById('scanner-results').classList.add('hidden');
            document.getElementById('scanner-error').classList.add('hidden');
            document.getElementById('github-repo-input').disabled = false;
        }

        async function scanGitHubRepo() {
            const input = document.getElementById('github-repo-input').value.trim();
            if (!input) {
                showToast("Please enter a repository URL or owner/repo", "error");
                return;
            }

            let owner, repo, branch = 'main';

            if (input.includes('github.com')) {
                const match = input.match(/github\.com\/([^\/]+)\/([^\/]+)(?:\/tree\/([^\/]+))?/);
                if (match) {
                    owner = match[1];
                    repo = match[2];
                    if (match[3]) branch = match[3];
                }
            } else {
                const parts = input.split('/');
                if (parts.length >= 2) {
                    owner = parts[0];
                    repo = parts[1];
                    if (parts[2]) branch = parts[2];
                }
            }

            if (!owner || !repo) {
                showToast("Invalid repository format. Use: owner/repo or full GitHub URL", "error");
                return;
            }

            Storage.set('neurorecall_last_repo', input);
            scannerRepoInfo = { owner, repo, branch };

            document.getElementById('scanner-loading').classList.remove('hidden');
            document.getElementById('scanner-results').classList.add('hidden');
            document.getElementById('scanner-error').classList.add('hidden');
            document.getElementById('github-repo-input').disabled = true;

            try {
                const treeUrl = `https://api.github.com/repos/${owner}/${repo}/git/trees/${branch}?recursive=1`;
                const response = await fetch(treeUrl);

                if (!response.ok) {
                    if (branch === 'main') {
                        scannerRepoInfo.branch = 'master';
                        const masterResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/trees/master?recursive=1`);
                        if (!masterResponse.ok) throw new Error(`HTTP ${response.status}`);
                        const data = await masterResponse.json();
                        processTreeResults(data);
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                processTreeResults(data);

            } catch (err) {
                console.error("Scan error:", err);
                document.getElementById('scanner-loading').classList.add('hidden');
                document.getElementById('scanner-error').classList.remove('hidden');
                document.getElementById('scanner-error-msg').textContent = 
                    err.message.includes('404') ? "Repository not found or not public" : 
                    err.message.includes('403') ? "API rate limit exceeded. Try again later." :
                    "Failed to fetch repository contents";
                document.getElementById('github-repo-input').disabled = false;
            }
        }

        function processTreeResults(data) {
            if (!data.tree || !Array.isArray(data.tree)) {
                throw new Error("Invalid response format");
            }

            scannerFiles = data.tree
                .filter(item => item.type === 'blob' && item.path.endsWith('.json'))
                .map(item => ({
                    path: item.path,
                    name: item.path.split('/').pop(),
                    size: item.size,
                    sha: item.sha,
                    selected: false,
                    url: `https://raw.githubusercontent.com/${scannerRepoInfo.owner}/${scannerRepoInfo.repo}/${scannerRepoInfo.branch}/${item.path}`
                }));

            document.getElementById('scanner-loading').classList.add('hidden');
            document.getElementById('github-repo-input').disabled = false;

            if (scannerFiles.length === 0) {
                document.getElementById('scanner-error').classList.remove('hidden');
                document.getElementById('scanner-error-msg').textContent = "No JSON files found in this repository";
                return;
            }

            renderScannerResults();
        }

        function renderScannerResults() {
            const list = document.getElementById('scanner-file-list');
            list.innerHTML = '';

            scannerFiles.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = `github-file-item p-3 rounded-lg border border-slate-700 bg-slate-800/50 flex items-center gap-3 cursor-pointer ${file.selected ? 'selected' : ''}`;
                item.onclick = () => toggleScannerFile(index);

                const folder = file.path.includes('/') ? file.path.substring(0, file.path.lastIndexOf('/')) : 'root';

                item.innerHTML = `
                    <input type="checkbox" ${file.selected ? 'checked' : ''} class="w-4 h-4 rounded border-slate-500 text-cyan-400 focus:ring-cyan-400 bg-slate-800 pointer-events-none">
                    <div class="flex-grow min-w-0">
                        <div class="font-medium text-white text-sm truncate">${file.name}</div>
                        <div class="text-xs text-slate-500 truncate">${folder} â€¢ ${formatBytes(file.size)}</div>
                    </div>
                    <i class="fa-solid fa-file-code text-cyan-400"></i>
                `;

                list.appendChild(item);
            });

            document.getElementById('scanner-count').textContent = scannerFiles.length;
            document.getElementById('scanner-results').classList.remove('hidden');
            updateSelectedCount();
        }

        function toggleScannerFile(index) {
            scannerFiles[index].selected = !scannerFiles[index].selected;
            renderScannerResults();
        }

        function selectAllScannerFiles(select) {
            scannerFiles.forEach(f => f.selected = select);
            renderScannerResults();
        }

        function updateSelectedCount() {
            const count = scannerFiles.filter(f => f.selected).length;
            document.getElementById('scanner-selected-count').textContent = count;
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function importSelectedFiles() {
            const selected = scannerFiles.filter(f => f.selected);
            if (selected.length === 0) {
                showToast("Please select at least one file to import", "error");
                return;
            }

            showToast(`Importing ${selected.length} file(s)...`, "info");

            let imported = 0;
            let failed = 0;

            for (const file of selected) {
                try {
                    const deckName = file.name.replace('.json', '').replace(/_/g, ' ').replace(/-/g, ' ');
                    await loadRemoteDeck(deckName, file.url, false);
                    imported++;
                } catch (err) {
                    console.error(`Failed to import ${file.name}:`, err);
                    failed++;
                }
            }

            saveToStorage();
            renderHome();

            if (imported > 0) showToast(`Successfully imported ${imported} deck(s)`, "success");
            if (failed > 0) showToast(`${failed} file(s) failed to import`, "error");

            showHome();
        }

        async function loadPresetDecks() {
            if (presets.length === 0) return;
            showToast("Loading remote decks...", "info");

            for (const preset of presets) {
                try {
                    await loadRemoteDeck(preset.name, preset.url, false);
                } catch (err) {
                    console.error("Failed to load preset:", preset.name, err);
                }
            }
            saveToStorage();
            renderHome();
        }

        async function loadRemoteDeck(name, url, showNotifications = true) {
            try {
                let fetchUrl = url;
                if (url.includes('raw.githubusercontent.com')) {
                    const match = url.match(/raw\.githubusercontent\.com\/([^\/]+)\/([^\/]+)\/([^\/]+)\/(.+)/);
                    if (match) {
                        fetchUrl = `https://cdn.jsdelivr.net/gh/${match[1]}/${match[2]}@${match[3]}/${match[4]}`;
                    }
                }

                const response = await fetch(fetchUrl);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();

                const existingIndex = decks.findIndex(d => 
                    d.remoteUrl === url || (d.name === name && !d.isLocal)
                );

                const normalizedQuestions = normalizeQuestions(data);

                const deckData = {
                    id: existingIndex >= 0 ? decks[existingIndex].id : Date.now().toString() + Math.random(),
                    name: name,
                    remoteUrl: url,
                    isLocal: false,
                    lastSynced: new Date().toISOString(),
                    questions: normalizedQuestions
                };

                if (existingIndex >= 0) {
                    const oldDeck = decks[existingIndex];
                    deckData.questions = mergeQuestions(oldDeck.questions, normalizedQuestions);
                    decks[existingIndex] = deckData;
                } else {
                    decks.push(deckData);
                }

                if (showNotifications) showToast(`Loaded "${name}" with ${normalizedQuestions.length} questions`, "success");
                return deckData;

            } catch (err) {
                if (showNotifications) showToast(`Failed to load "${name}": ${err.message}`, "error");
                throw err;
            }
        }

        function mergeQuestions(oldQuestions, newQuestions) {
            const questionMap = new Map();
            oldQuestions.forEach(q => questionMap.set(q.question, q));

            return newQuestions.map(newQ => {
                const existing = questionMap.get(newQ.question);
                if (existing) {
                    return {
                        ...newQ,
                        id: existing.id,
                        dueDate: existing.dueDate,
                        interval: existing.interval,
                        ease: existing.ease
                    };
                }
                return newQ;
            });
        }

        function normalizeQuestions(data) {
            if (!Array.isArray(data)) data = data.questions || [];

            return data.map((q, idx) => {
                let correctArray = [];
                let isMultiselect = false;
                let isFlashcardType = false;

                // Detect flashcard
                if (q.type === 'flashcard' || (!q.options && q.answer)) {
                    isFlashcardType = true;
                }

                if (!isFlashcardType) {
                    if (Array.isArray(q.correct)) {
                        correctArray = q.correct;
                        isMultiselect = correctArray.length > 1;
                    } else if (typeof q.correct === 'number') {
                        correctArray = [q.correct];
                    } else if (q.answer && typeof q.answer !== 'string') {
                        if (typeof q.answer === 'number') {
                            correctArray = [q.answer];
                        } else if (Array.isArray(q.answer)) {
                            if (q.options) {
                                correctArray = q.answer.map(ans => {
                                    let found = q.options.findIndex(opt => 
                                        opt.toLowerCase().trim() === ans.toLowerCase().trim()
                                    );
                                    if (found === -1) {
                                        found = q.options.findIndex(opt => 
                                            opt.toLowerCase().includes(ans.toLowerCase()) ||
                                            ans.toLowerCase().includes(opt.toLowerCase())
                                        );
                                    }
                                    return found !== -1 ? found : null;
                                }).filter(x => x !== null);
                            }
                            isMultiselect = correctArray.length > 1;
                        }
                    }
                }

                if (q.type === 'multiselect') isMultiselect = true;
                if (correctArray.length > 1) isMultiselect = true;

                let code = q.code || null;
                let questionText = q.question;

                const codeBlockMatch = questionText.match(/```(\w+)?\n?([\s\S]*?)```/);
                if (codeBlockMatch && !code) {
                    code = codeBlockMatch[2].trim();
                    questionText = questionText.replace(codeBlockMatch[0], '').trim();
                }

                return {
                    id: 'q_' + Date.now() + '_' + idx,
                    question: questionText,
                    options: q.options || [],
                    answer: q.answer || null,
                    correct: isMultiselect ? correctArray : (correctArray[0] || 0),
                    correctArray: correctArray,
                    isMultiselect: isMultiselect,
                    type: isFlashcardType ? 'flashcard' : (isMultiselect ? 'multiselect' : 'mcq'),
                    explanation: q.explanation || "No explanation provided",
                    category: q.category || "General",
                    code: code,
                    codeFront: q.codeFront || null,
                    codeBack: q.codeBack || null,
                    language: q.language || detectLanguage(code || '', q.category),
                    dueDate: new Date(),
                    interval: 0,
                    ease: 2.5
                };
            });
        }

        async function refreshRemoteDecks() {
            const remoteDecks = decks.filter(d => d.remoteUrl);
            if (remoteDecks.length === 0) {
                showToast("No remote decks to refresh", "info");
                return;
            }
            showToast("Refreshing remote decks...", "info");
            for (const deck of remoteDecks) {
                try {
                    await loadRemoteDeck(deck.name, deck.remoteUrl, false);
                } catch (err) {
                    console.error("Refresh failed for:", deck.name);
                }
            }
            saveToStorage();
            renderHome();
            showToast("All decks refreshed!", "success");
        }

        async function refreshCurrentDeck() {
            if (!selectedManagerDeckId) return;
            const deck = decks.find(d => d.id === selectedManagerDeckId);
            if (!deck || !deck.remoteUrl) return;
            showToast("Refreshing...", "info");
            try {
                await loadRemoteDeck(deck.name, deck.remoteUrl, true);
                renderEditor(selectedManagerDeckId);
                renderManager();
            } catch (err) {}
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <i class="fa-solid ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function hideAllViews() {
            ['view-home', 'view-quiz', 'view-flashcard', 'view-manager', 'view-preset-config', 'view-github-scanner', 'view-guide', 'view-stats'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
        }

        function showHome() {
            hideAllViews();
            document.getElementById('view-home').classList.remove('hidden');
            renderHome();
        }

        function showManager() {
            hideAllViews();
            document.getElementById('view-manager').classList.remove('hidden');
            renderManager();
        }

        function showSettings() {
            hideAllViews();
            document.getElementById('view-preset-config').classList.remove('hidden');
            renderPresetConfig();
        }

        function showPresetConfig() {
            hideAllViews();
            document.getElementById('view-preset-config').classList.remove('hidden');
            renderPresetConfig();
        }

        function showGuide() {
            hideAllViews();
            document.getElementById('view-guide').classList.remove('hidden');
        }

        function showStats() {
            hideAllViews();
            document.getElementById('view-stats').classList.remove('hidden');
            renderStats();
        }

        function renderStats() {
            const now = new Date();
            const today = now.toDateString();

            // Calculate totals
            let totalCards = 0;
            let dueToday = 0;
            let mcqCount = 0;
            let flashCount = 0;
            let mastered = 0;
            let learning = 0;

            decks.forEach(deck => {
                if (deck.questions) {
                    deck.questions.forEach(q => {
                        totalCards++;
                        if (isFlashcard(q)) {
                            flashCount++;
                        } else {
                            mcqCount++;
                        }

                        if (new Date(q.dueDate) <= now) {
                            dueToday++;
                        }

                        if (q.interval > 21) {
                            mastered++;
                        } else if (q.interval > 0) {
                            learning++;
                        }
                    });
                }
            });

            document.getElementById('stat-total-cards').textContent = totalCards;
            document.getElementById('stat-due-today').textContent = dueToday;
            document.getElementById('stat-studied-today').textContent = studyStats.studiedToday || 0;
            document.getElementById('stat-current-streak').textContent = currentStreak;
            document.getElementById('stat-mcq-count').textContent = mcqCount;
            document.getElementById('stat-flash-count').textContent = flashCount;
            document.getElementById('stat-mastered').textContent = mastered;
            document.getElementById('stat-learning').textContent = learning;

            // Calculate retention
            const retention = studyStats.totalReviews > 0 
                ? Math.round((studyStats.correctReviews / studyStats.totalReviews) * 100) 
                : 0;
            document.getElementById('stat-retention').textContent = retention + '%';

            // Update bars
            const total = mcqCount + flashCount;
            if (total > 0) {
                document.getElementById('stat-mcq-bar').style.width = (mcqCount / total * 100) + '%';
                document.getElementById('stat-flash-bar').style.width = (flashCount / total * 100) + '%';
            }

            // Render activity chart
            const chart = document.getElementById('activity-chart');
            chart.innerHTML = '';

            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = d.toDateString();
                const count = studyStats.dailyActivity[dateStr] || 0;
                const maxCount = Math.max(...Object.values(studyStats.dailyActivity), 10);
                const height = maxCount > 0 ? (count / maxCount * 100) : 0;

                const bar = document.createElement('div');
                bar.className = 'flex-1 flex flex-col items-center justify-end';
                bar.innerHTML = `
                    <div class="w-full bg-slate-700 rounded-t-lg relative" style="height: ${Math.max(height, 5)}%">
                        <div class="absolute bottom-0 w-full bg-cyan-400 rounded-t-lg transition-all" style="height: 100%"></div>
                    </div>
                    <span class="text-xs text-slate-500 mt-1">${d.toLocaleDateString('en-US', {weekday: 'narrow'})}</span>
                `;
                chart.appendChild(bar);
            }
        }

        function renderHome() {
            const remoteGrid = document.getElementById('remote-deck-grid');
            const localGrid = document.getElementById('deck-grid');
            const remoteSection = document.getElementById('remote-decks-section');
            const localSection = document.getElementById('local-decks-section');

            remoteGrid.innerHTML = '';
            localGrid.innerHTML = '';

            const remoteDecks = decks.filter(d => !d.isLocal);
            const localDecks = decks.filter(d => d.isLocal !== false);

            remoteSection.classList.toggle('hidden', remoteDecks.length === 0);
            localSection.classList.toggle('hidden', localDecks.length === 0);

            remoteDecks.forEach(deck => {
                remoteGrid.appendChild(createDeckCard(deck, true));
            });
            localDecks.forEach(deck => {
                localGrid.appendChild(createDeckCard(deck, false));
            });
        }

        function createDeckCard(deck, isRemote) {
            const dueCount = deck.questions.filter(q => new Date(q.dueDate) <= new Date()).length;
            const total = deck.questions.length;
            const flashCount = deck.questions.filter(q => isFlashcard(q)).length;
            const mcqCount = total - flashCount;

            const card = document.createElement('div');
            card.className = 'glass-panel rounded-xl p-6 hover:bg-white/5 transition-all cursor-pointer border-l-4 group relative overflow-hidden ' + 
                (isRemote ? 'border-purple-400' : 'border-cyan-400');

            // Check if deck has mixed types
            const hasMixed = flashCount > 0 && mcqCount > 0;

            card.innerHTML = `
                ${isRemote ? '<span class="absolute top-3 right-3 text-[10px] font-bold px-2 py-1 rounded-full remote-badge text-white"><i class="fa-solid fa-cloud mr-1"></i>CLOUD</span>' : ''}
                <div class="flex justify-between items-start mb-4 pr-16">
                    <h3 class="text-xl font-bold text-white group-hover:text-cyan-400 transition-colors">${deck.name}</h3>
                </div>
                <div class="flex items-center gap-2 mb-4">
                    ${flashCount > 0 ? `<span class="text-[10px] px-2 py-1 rounded-full bg-pink-400/20 text-pink-400"><i class="fa-solid fa-layer-group mr-1"></i>${flashCount} Flash</span>` : ''}
                    ${mcqCount > 0 ? `<span class="text-[10px] px-2 py-1 rounded-full bg-cyan-400/20 text-cyan-400"><i class="fa-solid fa-list-check mr-1"></i>${mcqCount} MCQ</span>` : ''}
                </div>
                <div class="flex items-center justify-between mt-4">
                    <div>
                        <span class="text-xs text-slate-500 uppercase font-bold">Due Now</span>
                        <div class="text-2xl font-bold text-white">${dueCount}</div>
                    </div>
                    <div class="text-right">
                        <span class="bg-slate-800 text-xs font-mono px-2 py-1 rounded text-slate-300">${total} cards</span>
                        <div class="mt-2 flex gap-2">
                            ${flashCount > 0 ? `<button onclick="event.stopPropagation(); startFlashcardSession('${deck.id}')" class="w-10 h-10 rounded-full bg-pink-400/10 flex items-center justify-center text-pink-400 hover:bg-pink-400 hover:text-white transition-all" title="Flashcards"><i class="fa-solid fa-layer-group"></i></button>` : ''}
                            ${mcqCount > 0 ? `<button onclick="event.stopPropagation(); startSession('${deck.id}')" class="w-10 h-10 rounded-full bg-cyan-400/10 flex items-center justify-center text-cyan-400 hover:bg-cyan-400 hover:text-slate-900 transition-all" title="MCQs"><i class="fa-solid fa-play ml-1"></i></button>` : ''}
                        </div>
                    </div>
                </div>
            `;

            // Click on card body starts appropriate session
            card.addEventListener('click', (e) => {
                if (e.target.closest('button')) return;
                if (flashCount > 0 && mcqCount === 0) {
                    startFlashcardSession(deck.id);
                } else {
                    startSession(deck.id);
                }
            });

            return card;
        }

        // Quiz functionality
        function startSession(deckId) {
            activeDeckId = deckId;
            const deck = decks.find(d => d.id === deckId);

            if (!deck || !deck.questions) {
                showToast("Deck not found or empty", "error");
                return;
            }

            // Filter only MCQs
            const mcqs = deck.questions.filter(q => !isFlashcard(q));

            if (mcqs.length === 0) {
                showToast("No MCQs in this deck. Try flashcards instead!", "info");
                return;
            }

            const now = new Date();
            sessionQueue = mcqs
                .map((q, idx) => ({ ...q, deckIndex: deck.questions.indexOf(q) }))
                .filter(q => new Date(q.dueDate) <= now)
                .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

            if (sessionQueue.length === 0) {
                showToast("No cards due in this deck! Great job.", "info");
                return;
            }

            currentCardIndex = 0;
            selectedOptions.clear();

            hideAllViews();
            document.getElementById('view-quiz').classList.remove('hidden');
            renderCard();
        }

        function endSession() {
            if(confirm("End current session?")) showHome();
        }

        function renderCard() {
            if (currentCardIndex >= sessionQueue.length) {
                document.getElementById('view-quiz').innerHTML = `
                    <div class="text-center animate-fade-in py-20 glass-panel rounded-2xl">
                        <div class="text-6xl mb-4">ðŸŽ‰</div>
                        <h2 class="text-3xl font-bold text-white mb-4">Session Complete!</h2>
                        <p class="text-slate-400 mb-8">You've cleared all due cards.</p>
                        <button onclick="showHome()" class="bg-cyan-400 text-slate-900 font-bold px-6 py-3 rounded-lg hover:bg-cyan-300">Return Home</button>
                    </div>
                `;
                return;
            }

            const card = sessionQueue[currentCardIndex];
            isAnswerRevealed = false;
            selectedOptions.clear();

            // Reset UI
            document.getElementById('explanation-area').classList.add('hidden');
            document.getElementById('controls-initial').classList.remove('hidden');
            document.getElementById('controls-difficulty').classList.add('hidden');
            document.getElementById('options-container').innerHTML = '';
            document.getElementById('submit-container').classList.add('hidden');
            document.getElementById('multiselect-hint').classList.add('hidden');
            document.getElementById('card-type-badge').classList.add('hidden');
            document.getElementById('correct-answers-display').classList.add('hidden');
            document.getElementById('code-block').classList.add('hidden');

            const formatted = formatQuestionText(card.question, card.code, card.category);

            document.getElementById('card-category').innerText = card.category || 'General';
            document.getElementById('question-text').innerHTML = formatted.text;

            if (formatted.code) {
                const codeBlock = document.getElementById('code-block');
                const codeContent = document.getElementById('code-content');
                codeBlock.classList.remove('hidden');
                codeContent.textContent = formatted.code;
                const lang = card.language || formatted.language || 'java';
                codeContent.className = `language-${lang}`;
                if (window.Prism) {
                    Prism.highlightElement(codeContent);
                }
            }

            const isMulti = isMultiSelect(card);
            document.getElementById('stat-question-type').innerText = isMulti ? 'Multi' : 'Single';

            if (isMulti) {
                document.getElementById('card-type-badge').classList.remove('hidden');
                document.getElementById('multiselect-hint').classList.remove('hidden');
                document.getElementById('initial-hint').innerText = "Select all that apply, then click Submit";
                document.getElementById('submit-container').classList.remove('hidden');
            } else {
                document.getElementById('initial-hint').innerText = "Select an answer to reveal";
            }

            const optsContainer = document.getElementById('options-container');
            card.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = `option-card w-full text-left p-4 rounded-xl border border-slate-700 bg-slate-800/50 text-slate-300 font-medium relative overflow-hidden`;
                btn.dataset.index = idx;

                const formattedOpt = opt.replace(/`([^`]+)`/g, '<code>$1</code>');

                btn.innerHTML = `
                    <span class="inline-block w-6 font-mono text-slate-500 opacity-50">${String.fromCharCode(65+idx)}.</span> 
                    <span class="option-text">${formattedOpt}</span>
                    ${isMulti ? '<span class="ml-2 text-slate-600 check-icon"><i class="fa-regular fa-square"></i></span>' : ''}
                `;

                if (isMulti) {
                    btn.onclick = () => toggleMultiSelectOption(idx, btn);
                } else {
                    btn.onclick = () => handleSingleAnswer(idx, btn, card);
                }

                optsContainer.appendChild(btn);
            });

            document.getElementById('stat-progress').innerText = `${currentCardIndex + 1}/${sessionQueue.length}`;
            document.getElementById('stat-due').innerText = sessionQueue.length - currentCardIndex;
        }

        function toggleMultiSelectOption(index, btn) {
            if (isAnswerRevealed) return;

            const checkIcon = btn.querySelector('.check-icon');

            if (selectedOptions.has(index)) {
                selectedOptions.delete(index);
                btn.classList.remove('user-selected', 'bg-cyan-400/10', 'border-cyan-400');
                checkIcon.innerHTML = '<i class="fa-regular fa-square"></i>';
            } else {
                selectedOptions.add(index);
                btn.classList.add('user-selected', 'bg-cyan-400/10', 'border-cyan-400');
                checkIcon.innerHTML = '<i class="fa-solid fa-square-check text-cyan-400"></i>';
            }
        }

        function submitMultiSelect() {
            if (isAnswerRevealed || selectedOptions.size === 0) return;
            const card = sessionQueue[currentCardIndex];
            checkMultiSelectAnswer(Array.from(selectedOptions), card);
        }

        function handleSingleAnswer(selectedIndex, btnElement, card) {
            if (isAnswerRevealed) return;
            isAnswerRevealed = true;

            const correctIndex = Array.isArray(card.correct) ? card.correct[0] : card.correct;
            const isCorrect = selectedIndex === correctIndex;
            const options = document.getElementById('options-container').children;

            if (isCorrect) {
                btnElement.classList.add('selected-correct');
                showFeedback(true, "Correct!");
            } else {
                btnElement.classList.add('selected-wrong');
                if (options[correctIndex]) {
                    options[correctIndex].classList.add('selected-correct');
                }
                showFeedback(false, "Incorrect");
            }

            Array.from(options).forEach(b => b.classList.add('disabled', 'cursor-default'));
            showExplanation(card);
        }

        function checkMultiSelectAnswer(selectedIndices, card) {
            isAnswerRevealed = true;

            const correctSet = new Set(card.correctArray || normalizeCorrect(card.correct));
            const options = document.getElementById('options-container').children;

            const isCorrect = selectedIndices.length === correctSet.size && 
                             selectedIndices.every(idx => correctSet.has(idx));

            selectedIndices.forEach(idx => {
                if (idx >= options.length) return;
                const btn = options[idx];
                if (correctSet.has(idx)) {
                    btn.classList.add('selected-correct');
                } else {
                    btn.classList.add('selected-wrong');
                }
            });

            correctSet.forEach(idx => {
                if (idx >= options.length) return;
                if (!selectedIndices.includes(idx)) {
                    options[idx].classList.add('selected-partial');
                }
            });

            const correctLabels = Array.from(correctSet).sort().map(i => 
                `${String.fromCharCode(65+i)}. ${card.options[i]}`
            ).join(', ');

            document.getElementById('correct-answers-list').innerText = correctLabels;
            document.getElementById('correct-answers-display').classList.remove('hidden');

            showFeedback(isCorrect, isCorrect ? "Correct! All answers match." : "Incorrect - see correct answers above");
            Array.from(options).forEach(b => b.classList.add('disabled', 'cursor-default'));
            showExplanation(card);
        }

        function showFeedback(isCorrect, title) {
            const titleEl = document.getElementById('feedback-title');
            const iconEl = document.getElementById('feedback-icon');

            titleEl.innerText = title;

            if (isCorrect) {
                titleEl.className = "text-lg font-bold text-emerald-400 mb-2";
                iconEl.innerHTML = '<i class="fa-solid fa-circle-check text-emerald-400"></i>';
            } else {
                titleEl.className = "text-lg font-bold text-red-400 mb-2";
                iconEl.innerHTML = '<i class="fa-solid fa-circle-xmark text-red-400"></i>';
            }
        }

        function showExplanation(card) {
            const formattedExp = formatQuestionText(card.explanation, null, card.category);
            document.getElementById('explanation-text').innerHTML = formattedExp.text;

            document.getElementById('explanation-area').classList.remove('hidden');
            document.getElementById('submit-container').classList.add('hidden');
            document.getElementById('controls-initial').classList.add('hidden');
            document.getElementById('controls-difficulty').classList.remove('hidden');
            document.getElementById('controls-difficulty').classList.add('grid');
        }

        function rateCard(rating) {
            const card = sessionQueue[currentCardIndex];
            let interval = 0;
            let ease = card.ease || SETTINGS.easeFactor;

            if (rating === 'again') {
                interval = SETTINGS.again;
                ease = Math.max(1.3, ease - 0.2);
            } else {
                if (card.interval === 0) {
                    if (rating === 'hard') interval = SETTINGS.hard;
                    else if (rating === 'good') interval = SETTINGS.good;
                    else if (rating === 'easy') interval = SETTINGS.easy;
                } else {
                    if (rating === 'hard') interval = (card.interval * SETTINGS.hard) / SETTINGS.easeFactor;
                    else if (rating === 'good') interval = card.interval * ease;
                    else if (rating === 'easy') {
                        interval = card.interval * ease * SETTINGS.easeBonus;
                        ease += 0.15;
                    }
                }
            }

            const deck = decks.find(d => d.id === activeDeckId);
            if (!deck || !deck.questions[card.deckIndex]) return;

            const masterQ = deck.questions[card.deckIndex];
            masterQ.interval = interval;
            masterQ.ease = ease;

            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + interval);
            masterQ.dueDate = dueDate;

            updateStats(rating);
            saveToStorage();
            currentCardIndex++;
            renderCard();
        }

        function skipCard() {
            currentCardIndex++;
            renderCard();
        }

        // Flashcard functionality
        function startFlashcardSession(deckId) {
            activeDeckId = deckId;
            const deck = decks.find(d => d.id === deckId);

            if (!deck || !deck.questions) {
                showToast("Deck not found or empty", "error");
                return;
            }

            // Filter only flashcards
            const flashcards = deck.questions.filter(q => isFlashcard(q));

            if (flashcards.length === 0) {
                showToast("No flashcards in this deck. Try MCQs instead!", "info");
                return;
            }

            const now = new Date();
            flashcardQueue = flashcards
                .map((q, idx) => ({ ...q, deckIndex: deck.questions.indexOf(q) }))
                .filter(q => new Date(q.dueDate) <= now)
                .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

            if (flashcardQueue.length === 0) {
                showToast("No flashcards due in this deck! Great job.", "info");
                return;
            }

            currentFlashcardIndex = 0;

            hideAllViews();
            document.getElementById('view-flashcard').classList.remove('hidden');
            renderFlashcard();
        }

        function endFlashcardSession() {
            if(confirm("End current session?")) showHome();
        }

        function renderFlashcard() {
            if (currentFlashcardIndex >= flashcardQueue.length) {
                document.getElementById('view-flashcard').innerHTML = `
                    <div class="text-center animate-fade-in py-20 glass-panel rounded-2xl">
                        <div class="text-6xl mb-4">ðŸŽ‰</div>
                        <h2 class="text-3xl font-bold text-white mb-4">Session Complete!</h2>
                        <p class="text-slate-400 mb-8">You've cleared all due flashcards.</p>
                        <button onclick="showHome()" class="bg-pink-400 text-white font-bold px-6 py-3 rounded-lg hover:bg-pink-300">Return Home</button>
                    </div>
                `;
                return;
            }

            const card = flashcardQueue[currentFlashcardIndex];

            // Reset flip state
            const flashcardEl = document.getElementById('flashcard');
            flashcardEl.classList.remove('flipped');

            // Front content
            document.getElementById('flashcard-question').innerHTML = formatQuestionText(card.question, null, card.category).text;

            // Front code
            const codeFront = card.codeFront || card.code;
            if (codeFront) {
                document.getElementById('flashcard-code-front').classList.remove('hidden');
                const codeEl = document.getElementById('flashcard-code-content-front');
                codeEl.textContent = codeFront;
                codeEl.className = `language-${card.language || detectLanguage(codeFront, card.category)}`;
                if (window.Prism) Prism.highlightElement(codeEl);
            } else {
                document.getElementById('flashcard-code-front').classList.add('hidden');
            }

            // Back content
            document.getElementById('flashcard-answer').innerHTML = formatQuestionText(card.answer, null, card.category).text;
            document.getElementById('flashcard-explanation').innerHTML = card.explanation ? formatQuestionText(card.explanation, null, card.category).text : '';

            // Back code
            if (card.codeBack) {
                document.getElementById('flashcard-code-back').classList.remove('hidden');
                const codeEl = document.getElementById('flashcard-code-content-back');
                codeEl.textContent = card.codeBack;
                codeEl.className = `language-${card.language || detectLanguage(card.codeBack, card.category)}`;
                if (window.Prism) Prism.highlightElement(codeEl);
            } else {
                document.getElementById('flashcard-code-back').classList.add('hidden');
            }

            document.getElementById('flash-stat-progress').innerText = `${currentFlashcardIndex + 1}/${flashcardQueue.length}`;
            document.getElementById('flash-stat-due').innerText = flashcardQueue.length - currentFlashcardIndex;
            document.getElementById('flash-stat-streak').innerText = `${currentStreak} ðŸ”¥`;
        }

        function flipFlashcard() {
            document.getElementById('flashcard').classList.toggle('flipped');
        }

        function rateFlashcard(rating) {
            const card = flashcardQueue[currentFlashcardIndex];
            let interval = 0;
            let ease = card.ease || SETTINGS.easeFactor;

            if (rating === 'again') {
                interval = SETTINGS.again;
                ease = Math.max(1.3, ease - 0.2);
            } else {
                if (card.interval === 0) {
                    if (rating === 'hard') interval = SETTINGS.hard;
                    else if (rating === 'good') interval = SETTINGS.good;
                    else if (rating === 'easy') interval = SETTINGS.easy;
                } else {
                    if (rating === 'hard') interval = (card.interval * SETTINGS.hard) / SETTINGS.easeFactor;
                    else if (rating === 'good') interval = card.interval * ease;
                    else if (rating === 'easy') {
                        interval = card.interval * ease * SETTINGS.easeBonus;
                        ease += 0.15;
                    }
                }
            }

            const deck = decks.find(d => d.id === activeDeckId);
            if (!deck || !deck.questions[card.deckIndex]) return;

            const masterQ = deck.questions[card.deckIndex];
            masterQ.interval = interval;
            masterQ.ease = ease;

            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + interval);
            masterQ.dueDate = dueDate;

            updateStats(rating);
            saveToStorage();
            currentFlashcardIndex++;
            renderFlashcard();
        }

        // Manager functionality
        function renderManager() {
            const list = document.getElementById('manager-deck-list');
            list.innerHTML = '';

            decks.forEach(deck => {
                const isRemote = !deck.isLocal;
                const flashCount = deck.questions ? deck.questions.filter(q => isFlashcard(q)).length : 0;
                const mcqCount = (deck.questions ? deck.questions.length : 0) - flashCount;

                const item = document.createElement('div');
                item.className = `p-3 rounded-lg cursor-pointer flex justify-between items-center ${selectedManagerDeckId === deck.id ? 'bg-cyan-400/20 border border-cyan-400/30' : 'hover:bg-white/5 border border-transparent'}`;
                item.onclick = () => selectDeckForEdit(deck.id);

                const icon = isRemote ? '<i class="fa-solid fa-cloud text-purple-400 mr-2"></i>' : '<i class="fa-solid fa-hard-drive text-slate-500 mr-2"></i>';
                const typeBadges = [];
                if (mcqCount > 0) typeBadges.push(`<span class="text-[10px] text-cyan-400">${mcqCount} MCQ</span>`);
                if (flashCount > 0) typeBadges.push(`<span class="text-[10px] text-pink-400">${flashCount} Flash</span>`);

                const qCount = deck.questions ? deck.questions.length : 0;

                item.innerHTML = `
                    <div class="flex items-center flex-grow">
                        ${icon}
                        <div>
                            <div class="font-bold text-white text-sm">${deck.name}</div>
                            <div class="text-xs text-slate-400">${qCount} questions ${typeBadges.length > 0 ? 'â€¢ ' + typeBadges.join(' ') : ''}</div>
                        </div>
                    </div>
                    ${selectedManagerDeckId === deck.id ? '<i class="fa-solid fa-chevron-right text-cyan-400"></i>' : ''}
                `;
                list.appendChild(item);
            });

            if (selectedManagerDeckId) renderEditor(selectedManagerDeckId);
            else {
                document.getElementById('editor-empty').classList.remove('hidden');
                document.getElementById('editor-content').classList.add('hidden');
            }
        }

        function createNewDeck() {
            const name = prompt("Enter new deck name:");
            if (name) {
                decks.push({
                    id: Date.now().toString(),
                    name: name,
                    isLocal: true,
                    questions: []
                });
                saveToStorage();
                selectedManagerDeckId = decks[decks.length - 1].id;
                renderManager();
                showToast("Deck created!", "success");
            }
        }

        function selectDeckForEdit(id) {
            selectedManagerDeckId = id;
            renderManager();
        }

        function renderEditor(deckId) {
            document.getElementById('editor-empty').classList.add('hidden');
            document.getElementById('editor-content').classList.remove('hidden');

            const deck = decks.find(d => d.id === deckId);
            if (!deck) return;

            document.getElementById('edit-deck-name').value = deck.name;
            document.getElementById('edit-q-count').innerText = deck.questions ? deck.questions.length : 0;

            const isRemote = !deck.isLocal;
            document.getElementById('btn-refresh').classList.toggle('hidden', !isRemote);
            document.getElementById('local-upload').classList.toggle('hidden', isRemote);
            document.getElementById('remote-info').classList.toggle('hidden', !isRemote);

            if (isRemote && deck.remoteUrl) {
                document.getElementById('remote-url').href = deck.remoteUrl;
                document.getElementById('remote-url').innerText = deck.remoteUrl;
            }

            const qList = document.getElementById('edit-questions-list');
            qList.innerHTML = '';

            if (!deck.questions || deck.questions.length === 0) {
                qList.innerHTML = '<div class="text-center text-slate-500 py-8 italic">No questions yet.</div>';
                return;
            }

            deck.questions.forEach((q, idx) => {
                const row = document.createElement('div');
                row.className = 'bg-slate-800/50 p-3 rounded border border-slate-700 flex justify-between items-center group';

                const isFlash = isFlashcard(q);
                const typeIcon = isFlash 
                    ? '<i class="fa-solid fa-layer-group text-pink-400 mr-2" title="Flashcard"></i>' 
                    : (q.isMultiselect ? '<i class="fa-solid fa-check-double text-yellow-400 mr-2" title="Multi-select"></i>' : '<i class="fa-solid fa-list-check text-cyan-400 mr-2" title="MCQ"></i>');
                const hasCode = q.code || q.codeFront || q.codeBack ? '<i class="fa-solid fa-code text-cyan-400 mr-2" title="Has code"></i>' : '';

                const displayText = isFlash ? q.question : q.question;
                const answerInfo = isFlash 
                    ? `Answer: ${q.answer ? q.answer.substring(0, 30) + '...' : 'N/A'}` 
                    : `Options: ${q.options ? q.options.length : 0}`;

                row.innerHTML = `
                    <div class="truncate pr-4 flex-grow flex items-center">
                        ${typeIcon}${hasCode}
                        <div>
                            <div class="text-sm text-white font-medium truncate">${displayText}</div>
                            <div class="text-xs text-slate-500">${q.category || 'Uncategorized'} â€¢ ${answerInfo}</div>
                        </div>
                    </div>
                    ${deck.isLocal ? `
                    <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="editQuestion(${idx})" class="text-cyan-400 hover:text-white p-1"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="deleteQuestion(${idx})" class="text-red-400 hover:text-red-300 p-1"><i class="fa-solid fa-trash"></i></button>
                    </div>` : '<span class="text-xs text-slate-500"><i class="fa-solid fa-lock mr-1"></i>Remote</span>'}
                `;
                qList.appendChild(row);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const deckNameInput = document.getElementById('edit-deck-name');
            if (deckNameInput) {
                deckNameInput.addEventListener('input', (e) => {
                    if (selectedManagerDeckId) {
                        const deck = decks.find(d => d.id === selectedManagerDeckId);
                        if (deck && deck.isLocal) {
                            deck.name = e.target.value;
                            saveToStorage();
                        }
                    }
                });
            }
        });

        function deleteCurrentDeck() {
            if(!selectedManagerDeckId) return;
            if(confirm("Delete this deck?")) {
                decks = decks.filter(d => d.id !== selectedManagerDeckId);
                selectedManagerDeckId = null;
                saveToStorage();
                renderManager();
                showToast("Deck deleted", "success");
            }
        }

        function exportCurrentDeck() {
            if (!selectedManagerDeckId) return;
            const deck = decks.find(d => d.id === selectedManagerDeckId);
            if (!deck) return;

            const exportData = {
                name: deck.name,
                questions: deck.questions.map(q => ({
                    question: q.question,
                    options: q.options,
                    answer: q.answer,
                    correct: q.correct,
                    type: q.type,
                    explanation: q.explanation,
                    category: q.category,
                    code: q.code,
                    codeFront: q.codeFront,
                    codeBack: q.codeBack,
                    language: q.language
                }))
            };

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData, null, 2));
            const a = document.createElement('a');
            a.setAttribute("href", dataStr);
            a.setAttribute("download", deck.name.replace(/\s+/g, '_') + ".json");
            document.body.appendChild(a);
            a.click();
            a.remove();
            showToast("Deck exported!", "success");
        }

        async function importFromGitHub() {
            const url = prompt("Enter raw GitHub URL:");
            if (!url) return;
            if (!url.includes('raw.githubusercontent.com') && !url.includes('cdn.jsdelivr.net')) {
                showToast("Please use RAW GitHub URL or jsdelivr", "error");
                return;
            }
            const name = prompt("Name for this deck:", "Imported Deck");
            if (!name) return;
            try {
                await loadRemoteDeck(name, url, true);
                renderHome();
                showManager();
            } catch (err) {}
        }

        function setupDragAndDrop() {
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');

            if (dropZone) {
                dropZone.addEventListener('click', () => fileInput.click());
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('drag-over');
                });
                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('drag-over');
                });
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('drag-over');
                    handleFiles(e.dataTransfer.files);
                });
            }
            if (fileInput) {
                fileInput.addEventListener('change', (e) => {
                    handleFiles(e.target.files);
                    e.target.value = null;
                });
            }
        }

        function triggerFileUpload() {
            if (!selectedManagerDeckId) {
                showToast("Please select a deck first", "error");
                return;
            }
            const deck = decks.find(d => d.id === selectedManagerDeckId);
            if (!deck) {
                showToast("Deck not found", "error");
                return;
            }
            if (!deck.isLocal) {
                showToast("Cannot upload to remote deck", "error");
                return;
            }
            document.getElementById('file-input').click();
        }

        function handleFiles(files) {
            if (!selectedManagerDeckId) {
                showToast("Select a deck first", "error");
                return;
            }
            const deck = decks.find(d => d.id === selectedManagerDeckId);
            if (!deck) {
                showToast("Deck not found", "error");
                return;
            }
            if (!deck.isLocal) {
                showToast("Cannot modify remote deck", "error");
                return;
            }

            showToast(`Processing ${files.length} file(s)...`, "info");

            Array.from(files).forEach(file => {
                if (!file.name.endsWith('.json')) {
                    showToast(`Skipped ${file.name}: Not JSON`, "error");
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        processImportedData(data, file.name);
                    } catch (err) {
                        showToast(`Error parsing ${file.name}: ${err.message}`, "error");
                    }
                };
                reader.onerror = () => {
                    showToast(`Error reading ${file.name}`, "error");
                };
                reader.readAsText(file);
            });
        }

        function processImportedData(data, filename) {
            if (!selectedManagerDeckId) return;
            const deck = decks.find(d => d.id === selectedManagerDeckId);
            if (!deck) return;

            let imported = 0;
            let errors = [];

            let questionsToImport = Array.isArray(data) ? data : (data.questions || []);

            if (!Array.isArray(questionsToImport)) {
                showToast("Invalid JSON format: expected array or {questions: [...]}", "error");
                return;
            }

            questionsToImport.forEach((q, idx) => {
                try {
                    if (!q.question) {
                        errors.push(`Item ${idx + 1}: Missing question`);
                        return;
                    }

                    const isFlashcardType = q.type === 'flashcard' || (!q.options && q.answer);

                    if (isFlashcardType) {
                        // Process flashcard
                        let codeFront = q.codeFront || null;
                        let codeBack = q.codeBack || null;
                        let questionText = q.question;

                        const codeBlockMatch = questionText.match(/```(\w+)?\n?([\s\S]*?)```/);
                        if (codeBlockMatch && !codeFront) {
                            codeFront = codeBlockMatch[2].trim();
                            questionText = questionText.replace(codeBlockMatch[0], '').trim();
                        }

                        const newQ = {
                            id: Date.now().toString() + Math.random(),
                            question: questionText,
                            answer: q.answer || '',
                            explanation: q.explanation || "",
                            category: q.category || filename.replace('.json', ''),
                            type: 'flashcard',
                            codeFront: codeFront,
                            codeBack: codeBack,
                            code: null,
                            options: null,
                            language: q.language || detectLanguage(codeFront || codeBack || '', q.category),
                            dueDate: new Date(),
                            interval: 0,
                            ease: 2.5
                        };
                        deck.questions.push(newQ);
                        imported++;
                    } else {
                        // Process MCQ
                        if (!q.options) {
                            errors.push(`Item ${idx + 1}: Missing options for MCQ`);
                            return;
                        }

                        const isMultiselect = Array.isArray(q.correct) || q.type === 'multiselect';
                        let correctArray = [];

                        if (Array.isArray(q.correct)) {
                            correctArray = q.correct;
                        } else if (typeof q.correct === 'number') {
                            correctArray = [q.correct];
                        }

                        let code = q.code || null;
                        let questionText = q.question;

                        const codeBlockMatch = questionText.match(/```(\w+)?\n?([\s\S]*?)```/);
                        if (codeBlockMatch && !code) {
                            code = codeBlockMatch[2].trim();
                            questionText = questionText.replace(codeBlockMatch[0], '').trim();
                        }

                        const newQ = {
                            id: Date.now().toString() + Math.random(),
                            question: questionText,
                            options: q.options,
                            correct: isMultiselect ? correctArray : (correctArray[0] || 0),
                            correctArray: correctArray,
                            isMultiselect: isMultiselect,
                            type: isMultiselect ? 'multiselect' : 'mcq',
                            explanation: q.explanation || "No explanation",
                            category: q.category || filename.replace('.json', ''),
                            code: code,
                            codeFront: null,
                            codeBack: null,
                            answer: null,
                            language: q.language || detectLanguage(code || '', q.category),
                            dueDate: new Date(),
                            interval: 0,
                            ease: 2.5
                        };
                        deck.questions.push(newQ);
                        imported++;
                    }
                } catch (err) {
                    errors.push(`Item ${idx + 1}: ${err.message}`);
                }
            });

            saveToStorage();
            renderEditor(selectedManagerDeckId);
            if (imported > 0) showToast(`Imported ${imported} questions`, "success");
            if (errors.length > 0) showToast(`${errors.length} failed to import`, "error");
        }

        // Preset config
        function renderPresetConfig() {
            const list = document.getElementById('preset-list');
            list.innerHTML = '';

            presets.forEach((preset, idx) => {
                const item = document.createElement('div');
                item.className = 'flex items-center gap-3 p-3 bg-slate-800 rounded-lg border border-slate-700';
                item.innerHTML = `
                    <div class="flex-grow">
                        <div class="font-bold text-white text-sm">${preset.name}</div>
                        <div class="text-xs text-slate-500 truncate">${preset.url}</div>
                    </div>
                    <button onclick="removePreset(${idx})" class="text-red-400 hover:text-red-300 p-2">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                `;
                list.appendChild(item);
            });

            if (presets.length === 0) {
                list.innerHTML = '<div class="text-center text-slate-500 py-4 italic">No presets. Add GitHub URLs below.</div>';
            }
        }

        function addPreset() {
            const name = document.getElementById('new-preset-name').value.trim();
            const url = document.getElementById('new-preset-url').value.trim();

            if (!name || !url) {
                showToast("Enter both name and URL", "error");
                return;
            }
            if (!url.includes('raw.githubusercontent.com') && !url.includes('cdn.jsdelivr.net')) {
                showToast("Use raw GitHub URL or jsdelivr", "error");
                return;
            }

            presets.push({ name, url });
            document.getElementById('new-preset-name').value = '';
            document.getElementById('new-preset-url').value = '';
            renderPresetConfig();
            showToast("Preset added!", "success");
        }

        function removePreset(idx) {
            presets.splice(idx, 1);
            renderPresetConfig();
        }

        async function savePresetsAndLoad() {
            saveToStorage();
            await loadPresetDecks();
            showHome();
        }

        // Question modal functions
        function toggleCorrectAnswerInput() {
            const type = document.getElementById('q-input-type').value;
            const singleDiv = document.getElementById('correct-single');
            const multiDiv = document.getElementById('correct-multi');
            const label = document.getElementById('correct-answer-label');

            if (singleDiv) singleDiv.classList.toggle('hidden', type === 'multiselect');
            if (multiDiv) multiDiv.classList.toggle('hidden', type !== 'multiselect');
            if (label) label.innerText = type === 'multiselect' ? 'Correct Answers (check all)' : 'Correct Answer';
            updateCorrectSelect();
        }

        function openQuestionModal(index = null) {
            if (!selectedManagerDeckId) {
                showToast("Select a deck first", "error");
                return;
            }

            const deck = decks.find(d => d.id === selectedManagerDeckId);
            if (!deck || !deck.isLocal) {
                showToast("Cannot edit remote deck", "error");
                return;
            }

            editingQuestionIndex = index;
            const modal = document.getElementById('modal-question');

            document.getElementById('q-input-text').value = '';
            document.getElementById('q-input-category').value = '';
            document.getElementById('q-input-code').value = '';
            document.getElementById('q-input-explanation').value = '';
            document.getElementById('q-input-type').value = 'single';

            const optsContainer = document.getElementById('q-options-container');
            optsContainer.innerHTML = '';
            addOptionInput();
            addOptionInput();

            toggleCorrectAnswerInput();

            if (index !== null && deck.questions[index]) {
                const q = deck.questions[index];
                const isMulti = q.isMultiselect || (Array.isArray(q.correct) && q.correct.length > 1);

                document.getElementById('modal-title').innerText = "Edit Question";
                document.getElementById('q-input-text').value = q.question;
                document.getElementById('q-input-category').value = q.category || '';
                document.getElementById('q-input-code').value = q.code || '';
                document.getElementById('q-input-explanation').value = q.explanation;
                document.getElementById('q-input-type').value = isMulti ? 'multiselect' : 'single';

                optsContainer.innerHTML = '';
                if (q.options) {
                    q.options.forEach(opt => addOptionInput(opt));
                }

                toggleCorrectAnswerInput();

                setTimeout(() => {
                    const correctIndices = q.correctArray || normalizeCorrect(q.correct);
                    if (isMulti) {
                        const checkboxes = document.querySelectorAll('.multi-correct-checkbox');
                        checkboxes.forEach((cb, idx) => {
                            cb.checked = correctIndices.includes(idx);
                        });
                    } else {
                        const select = document.getElementById('q-input-correct');
                        if (select && correctIndices.length > 0) {
                            select.value = correctIndices[0];
                        }
                    }
                }, 0);
            } else {
                document.getElementById('modal-title').innerText = "Add Question";
            }

            updateCorrectSelect();
            modal.classList.remove('hidden');
        }

        function closeQuestionModal() {
            const modal = document.getElementById('modal-question');
            if (modal) modal.classList.add('hidden');
            editingQuestionIndex = null;
        }

        function addOptionInput(value = '') {
            const container = document.getElementById('q-options-container');
            if (!container) return;

            const div = document.createElement('div');
            div.className = 'flex gap-2 option-row';
            div.innerHTML = `
                <input type="text" class="custom-input option-input flex-grow" placeholder="Option..." value="${value.replace(/"/g, '&quot;')}">
                <button onclick="this.parentElement.remove(); updateCorrectSelect()" class="text-slate-500 hover:text-red-400 px-2"><i class="fa-solid fa-times"></i></button>
            `;
            container.appendChild(div);
            const input = div.querySelector('input');
            input.addEventListener('input', updateCorrectSelect);
            updateCorrectSelect();
        }

        function updateCorrectSelect() {
            const inputs = document.querySelectorAll('.option-input');
            const singleSelect = document.getElementById('q-input-correct');
            const multiContainer = document.getElementById('multi-correct-checkboxes');
            const isMulti = document.getElementById('q-input-type').value === 'multiselect';

            if (singleSelect) {
                const currentVal = singleSelect.value;
                singleSelect.innerHTML = '';

                inputs.forEach((input, idx) => {
                    if (input.value.trim() !== '') {
                        const opt = document.createElement('option');
                        opt.value = idx;
                        opt.text = `${String.fromCharCode(65+idx)}. ${input.value.substring(0, 50)}`;
                        singleSelect.appendChild(opt);
                    }
                });

                if (currentVal && singleSelect.options[parseInt(currentVal)]) {
                    singleSelect.value = currentVal;
                }
            }

            if (multiContainer) {
                multiContainer.innerHTML = '';
                inputs.forEach((input, idx) => {
                    if (input.value.trim() !== '') {
                        const label = document.createElement('label');
                        label.className = 'flex items-center gap-2 text-slate-300 cursor-pointer hover:bg-white/5 p-2 rounded';
                        label.innerHTML = `
                            <input type="checkbox" class="multi-correct-checkbox w-4 h-4 rounded border-slate-500 text-cyan-400 focus:ring-cyan-400 bg-slate-800" value="${idx}">
                            <span class="font-mono text-slate-500 w-6">${String.fromCharCode(65+idx)}.</span>
                            <span>${input.value}</span>
                        `;
                        multiContainer.appendChild(label);
                    }
                });
            }
        }

        function saveQuestion() {
            if (!selectedManagerDeckId) return;
            const deck = decks.find(d => d.id === selectedManagerDeckId);
            if (!deck) return;

            const text = document.getElementById('q-input-text').value.trim();
            const category = document.getElementById('q-input-category').value.trim();
            const code = document.getElementById('q-input-code').value;
            const explanation = document.getElementById('q-input-explanation').value.trim();
            const isMulti = document.getElementById('q-input-type').value === 'multiselect';

            const options = Array.from(document.querySelectorAll('.option-input'))
                .map(i => i.value.trim())
                .filter(v => v !== '');

            if (!text) {
                showToast("Enter a question", "error");
                return;
            }
            if (options.length < 2) {
                showToast("Need at least 2 options", "error");
                return;
            }

            let correct;
            let correctArray;

            if (isMulti) {
                const checked = Array.from(document.querySelectorAll('.multi-correct-checkbox:checked'))
                    .map(cb => parseInt(cb.value));
                if (checked.length === 0) {
                    showToast("Select at least one correct answer", "error");
                    return;
                }
                correctArray = checked;
                correct = correctArray;
            } else {
                const singleVal = parseInt(document.getElementById('q-input-correct').value);
                if (isNaN(singleVal) || singleVal >= options.length) {
                    showToast("Select correct answer", "error");
                    return;
                }
                correct = singleVal;
                correctArray = [singleVal];
            }

            const newQ = {
                id: editingQuestionIndex !== null ? (deck.questions[editingQuestionIndex]?.id || Date.now().toString()) : Date.now().toString(),
                question: text,
                options: options,
                correct: correct,
                correctArray: correctArray,
                isMultiselect: isMulti,
                type: isMulti ? 'multiselect' : 'mcq',
                explanation: explanation,
                category: category,
                code: code || null,
                codeFront: null,
                codeBack: null,
                answer: null,
                language: detectLanguage(code || '', category),
                dueDate: new Date(),
                interval: 0,
                ease: 2.5
            };

            if (editingQuestionIndex !== null && deck.questions[editingQuestionIndex]) {
                newQ.dueDate = deck.questions[editingQuestionIndex].dueDate;
                newQ.interval = deck.questions[editingQuestionIndex].interval;
                newQ.ease = deck.questions[editingQuestionIndex].ease;
                deck.questions[editingQuestionIndex] = newQ;
                showToast("Question updated!", "success");
            } else {
                deck.questions.push(newQ);
                showToast("Question added!", "success");
            }

            saveToStorage();
            renderEditor(selectedManagerDeckId);
            closeQuestionModal();
        }

        function editQuestion(index) {
            openQuestionModal(index);
        }

        function deleteQuestion(index) {
            if(!selectedManagerDeckId) return;
            if(confirm("Delete this question?")) {
                const deck = decks.find(d => d.id === selectedManagerDeckId);
                if (!deck || !deck.questions) return;

                deck.questions.splice(index, 1);
                saveToStorage();
                renderEditor(selectedManagerDeckId);
                showToast("Deleted", "success");
            }
        }

        // Flashcard modal functions
        let editingFlashcardIndex = null;

        function openFlashcardModal(index = null) {
            if (!selectedManagerDeckId) {
                showToast("Select a deck first", "error");
                return;
            }

            const deck = decks.find(d => d.id === selectedManagerDeckId);
            if (!deck || !deck.isLocal) {
                showToast("Cannot edit remote deck", "error");
                return;
            }

            editingFlashcardIndex = index;
            const modal = document.getElementById('modal-flashcard');

            document.getElementById('flash-input-front').value = '';
            document.getElementById('flash-input-back').value = '';
            document.getElementById('flash-input-category').value = '';
            document.getElementById('flash-input-code-front').value = '';
            document.getElementById('flash-input-code-back').value = '';
            document.getElementById('flash-input-explanation').value = '';

            if (index !== null) {
                const q = deck.questions[index];
                document.getElementById('flash-modal-title').innerText = "Edit Flashcard";
                document.getElementById('flash-input-front').value = q.question;
                document.getElementById('flash-input-back').value = q.answer || '';
                document.getElementById('flash-input-category').value = q.category || '';
                document.getElementById('flash-input-code-front').value = q.codeFront || q.code || '';
                document.getElementById('flash-input-code-back').value = q.codeBack || '';
                document.getElementById('flash-input-explanation').value = q.explanation || '';
            } else {
                document.getElementById('flash-modal-title').innerText = "Add Flashcard";
            }

            modal.classList.remove('hidden');
        }

        function closeFlashcardModal() {
            const modal = document.getElementById('modal-flashcard');
            if (modal) modal.classList.add('hidden');
            editingFlashcardIndex = null;
        }

        function saveFlashcard() {
            if (!selectedManagerDeckId) return;
            const deck = decks.find(d => d.id === selectedManagerDeckId);
            if (!deck) return;

            const front = document.getElementById('flash-input-front').value.trim();
            const back = document.getElementById('flash-input-back').value.trim();
            const category = document.getElementById('flash-input-category').value.trim();
            const codeFront = document.getElementById('flash-input-code-front').value;
            const codeBack = document.getElementById('flash-input-code-back').value;
            const explanation = document.getElementById('flash-input-explanation').value.trim();

            if (!front) {
                showToast("Enter front text", "error");
                return;
            }
            if (!back) {
                showToast("Enter back text", "error");
                return;
            }

            const newQ = {
                id: editingFlashcardIndex !== null ? (deck.questions[editingFlashcardIndex]?.id || Date.now().toString()) : Date.now().toString(),
                question: front,
                answer: back,
                explanation: explanation,
                category: category,
                type: 'flashcard',
                code: null,
                codeFront: codeFront || null,
                codeBack: codeBack || null,
                options: null,
                correct: null,
                correctArray: null,
                isMultiselect: false,
                language: detectLanguage(codeFront || codeBack || '', category),
                dueDate: new Date(),
                interval: 0,
                ease: 2.5
            };

            if (editingFlashcardIndex !== null && deck.questions[editingFlashcardIndex]) {
                newQ.dueDate = deck.questions[editingFlashcardIndex].dueDate;
                newQ.interval = deck.questions[editingFlashcardIndex].interval;
                newQ.ease = deck.questions[editingFlashcardIndex].ease;
                deck.questions[editingFlashcardIndex] = newQ;
                showToast("Flashcard updated!", "success");
            } else {
                deck.questions.push(newQ);
                showToast("Flashcard added!", "success");
            }

            saveToStorage();
            renderEditor(selectedManagerDeckId);
            closeFlashcardModal();
        }

        // Guide copy functions
        function copyToClipboard(elementId) {
            const el = document.getElementById(elementId);
            if (el) {
                navigator.clipboard.writeText(el.innerText).then(() => {
                    showToast("Copied to clipboard!", "success");
                });
            }
        }

        function copyText(btn) {
            const pre = btn.parentElement.querySelector('pre');
            if (pre) {
                navigator.clipboard.writeText(pre.innerText).then(() => {
                    showToast("Copied to clipboard!", "success");
                });
            }
        }
    </script>
</body>
</html>