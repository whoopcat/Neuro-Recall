<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroRecall | Smart MCQ Drill</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        dark: {
                            900: '#0f172a',
                            800: '#1e293b',
                            700: '#334155',
                        },
                        neon: {
                            blue: '#38bdf8',
                            purple: '#818cf8',
                            green: '#34d399',
                            red: '#fb7185',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .option-btn:hover .select-indicator { opacity: 0.5; }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>

<body class="min-h-screen flex flex-col font-sans">

    <nav class="border-b border-dark-700 bg-dark-900/80 sticky top-0 z-50 backdrop-blur-md">
        <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3 cursor-pointer" onclick="showSection('decks-section')">
                <i class="fa-solid fa-brain text-neon-purple text-2xl"></i>
                <span class="font-bold text-xl tracking-tight bg-gradient-to-r from-neon-blue to-neon-purple bg-clip-text text-transparent">NeuroRecall</span>
            </div>
            <div class="flex gap-4">
                <button onclick="exportData()" class="text-gray-400 hover:text-neon-blue transition" title="Export JSON"><i class="fa-solid fa-download"></i></button>
                <label class="text-gray-400 hover:text-neon-green transition cursor-pointer" title="Import JSON">
                    <i class="fa-solid fa-upload"></i>
                    <input type="file" onchange="importData(this)" class="hidden" accept=".json">
                </label>
            </div>
        </div>
    </nav>

    <main class="flex-1 max-w-6xl mx-auto w-full p-4">
        
        <section id="decks-section" class="space-y-6">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold text-white">Your Decks</h2>
                <button onclick="createDeck()" class="bg-neon-blue hover:bg-sky-400 text-dark-900 font-bold px-4 py-2 rounded-lg transition flex items-center gap-2 shadow-lg shadow-sky-500/20">
                    <i class="fa-solid fa-plus"></i> New Deck
                </button>
            </div>
            
            <div id="decks-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
        </section>

        <section id="quiz-section" class="hidden h-full flex flex-col">
            <div class="mb-6 flex justify-between items-center">
                <button onclick="exitQuiz()" class="text-gray-400 hover:text-white flex items-center gap-2">
                    <i class="fa-solid fa-arrow-left"></i> Quit
                </button>
                <div class="flex items-center gap-4">
                    <div class="text-sm text-gray-400">Due: <span id="due-count" class="text-neon-red font-bold">0</span></div>
                    <div class="w-32 h-2 bg-dark-700 rounded-full overflow-hidden">
                        <div id="progress-bar" class="h-full bg-neon-purple w-0 transition-all duration-300"></div>
                    </div>
                </div>
            </div>

            <div id="quiz-container" class="flex-1 flex flex-col justify-center max-w-3xl mx-auto w-full">
                </div>
        </section>

        <section id="manager-section" class="hidden">
            <div class="mb-6 flex items-center gap-4 border-b border-dark-700 pb-4">
                <button onclick="showSection('decks-section')" class="text-gray-400 hover:text-white">
                    <i class="fa-solid fa-arrow-left"></i> Back
                </button>
                <h2 id="manager-title" class="text-2xl font-bold text-white flex-1">Deck Editor</h2>
                <button onclick="openQuestionModal()" class="bg-neon-green text-dark-900 font-bold px-4 py-2 rounded transition hover:bg-emerald-400">
                    <i class="fa-solid fa-plus"></i> Add Question
                </button>
            </div>

            <div id="questions-list" class="space-y-3">
                </div>
        </section>

    </main>

    <div id="question-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-dark-800 border border-dark-700 w-full max-w-2xl rounded-xl shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-dark-700 flex justify-between items-center">
                <h3 id="modal-title" class="text-xl font-bold text-white">Add Question</h3>
                <button onclick="closeQuestionModal()" class="text-gray-500 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto space-y-4 flex-1">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Category / Tag</label>
                    <input type="text" id="category-input" class="w-full bg-dark-900 text-white p-2 rounded border border-dark-700 focus:border-neon-blue outline-none" placeholder="e.g. History, Math">
                </div>
                
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Question Text</label>
                    <textarea id="question-text" rows="3" class="w-full bg-dark-900 text-white p-3 rounded border border-dark-700 focus:border-neon-blue outline-none placeholder-gray-600" placeholder="Enter your question here..."></textarea>
                </div>

                <div>
                    <label class="block text-sm text-gray-400 mb-1">Code Snippet (Optional)</label>
                    <textarea id="code-snippet" rows="3" class="w-full bg-dark-900 text-gray-300 font-mono text-sm p-3 rounded border border-dark-700 focus:border-neon-purple outline-none" placeholder="// code here..."></textarea>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm text-gray-400">Options <span class="text-xs text-gray-500">(Check box for correct answer(s))</span></label>
                        <button onclick="addOptionInput()" class="text-xs text-neon-blue hover:text-white">+ Add Option</button>
                    </div>
                    <div id="add-options-container" class="space-y-2"></div>
                </div>

                <div>
                    <label class="block text-sm text-gray-400 mb-1">Explanation (Shown after answer)</label>
                    <textarea id="explanation-text" rows="2" class="w-full bg-dark-900 text-white p-3 rounded border border-dark-700 focus:border-neon-green outline-none" placeholder="Why is this correct?"></textarea>
                </div>
            </div>

            <div class="p-4 border-t border-dark-700 flex justify-end gap-3 bg-dark-800 rounded-b-xl">
                <button onclick="closeQuestionModal()" class="px-4 py-2 text-gray-400 hover:text-white">Cancel</button>
                <button onclick="saveQuestion()" class="px-6 py-2 bg-neon-blue text-dark-900 font-bold rounded hover:bg-sky-400 transition">Save</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 z-50 font-bold flex items-center gap-3"></div>

    <script>
        // --- DATA STATE ---
        let decks = JSON.parse(localStorage.getItem('neurorecall_decks')) || [];
        
        let selectedManagerDeckId = null;
        let quizQueue = [];
        let quizSessionTotal = 0;
        let currentDeckId = null;
        let editingQuestionIndex = null;
        let currentMultiSelections = []; // Store user clicks for multi-select

        // --- INIT ---
        function init() {
            if(decks.length === 0) {
                // Example Deck
                decks.push({
                    id: Date.now().toString(),
                    name: "Demo: Computer Science",
                    questions: [
                        {
                            id: "1", question: "Which algorithm is used for finding the shortest path in a graph?", 
                            options: ["Dijkstra's", "Quick Sort", "DFS", "Binary Search"], 
                            correct: "Dijkstra's", 
                            category: "Algorithms",
                            explanation: "Dijkstra's algorithm specifically targets shortest paths from a source node.",
                            dueDate: new Date(), interval: 0, ease: 2.5 
                        },
                        {
                            id: "2", question: "Which of the following are valid HTTP methods? (Select all that apply)", 
                            options: ["GET", "PUSH", "POST", "FETCH"], 
                            correct: ["GET", "POST"], 
                            category: "Web",
                            explanation: "GET and POST are standard HTTP methods. PUSH is not (PUT is). FETCH is a JS API, not a method.",
                            dueDate: new Date(), interval: 0, ease: 2.5 
                        }
                    ]
                });
                saveToStorage();
            }
            renderDecks();
        }

        // --- NAVIGATION ---
        function showSection(id) {
            ['decks-section', 'quiz-section', 'manager-section'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if(id === 'decks-section') renderDecks();
        }

        // --- DECK MANAGEMENT ---
        function renderDecks() {
            const container = document.getElementById('decks-container');
            container.innerHTML = '';

            decks.forEach(deck => {
                const dueCount = deck.questions.filter(q => new Date(q.dueDate) <= new Date()).length;
                
                const card = document.createElement('div');
                card.className = "glass-panel p-6 rounded-xl hover:border-neon-blue/50 transition group relative";
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-bold text-white group-hover:text-neon-blue transition">${deck.name}</h3>
                        <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition">
                            <button onclick="manageDeck('${deck.id}')" class="text-gray-400 hover:text-white p-1" title="Edit Deck"><i class="fa-solid fa-pen-to-square"></i></button>
                            <button onclick="deleteDeck('${deck.id}')" class="text-gray-400 hover:text-red-500 p-1" title="Delete Deck"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="flex justify-between items-end">
                        <div>
                            <div class="text-3xl font-bold text-white mb-1">${dueCount}</div>
                            <div class="text-xs text-gray-400 uppercase tracking-wider">Cards Due</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-500 mb-2">Total: ${deck.questions.length} cards</div>
                            <button onclick="startQuiz('${deck.id}')" ${dueCount === 0 ? 'disabled' : ''} 
                                class="px-4 py-2 rounded-lg font-bold text-sm transition ${dueCount > 0 ? 'bg-neon-blue text-dark-900 hover:bg-sky-400' : 'bg-dark-700 text-gray-500 cursor-not-allowed'}">
                                ${dueCount > 0 ? 'Review Now' : 'All Done'}
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function createDeck() {
            const name = prompt("Enter deck name:");
            if (name) {
                decks.push({ id: Date.now().toString(), name: name, questions: [] });
                saveToStorage();
                renderDecks();
            }
        }

        function deleteDeck(id) {
            if(confirm("Delete this deck and all its cards?")) {
                decks = decks.filter(d => d.id !== id);
                saveToStorage();
                renderDecks();
            }
        }

        // --- EDITOR LOGIC ---
        function manageDeck(id) {
            selectedManagerDeckId = id;
            const deck = decks.find(d => d.id === id);
            document.getElementById('manager-title').innerText = `Editing: ${deck.name}`;
            renderEditor(id);
            showSection('manager-section');
        }

        function renderEditor(deckId) {
            const deck = decks.find(d => d.id === deckId);
            const list = document.getElementById('questions-list');
            list.innerHTML = '';

            deck.questions.forEach((q, index) => {
                const item = document.createElement('div');
                item.className = "bg-dark-800 p-4 rounded-lg border border-dark-700 flex justify-between items-center hover:border-gray-600";
                
                // Badge for Multi/Single
                const typeBadge = Array.isArray(q.correct) 
                    ? `<span class="text-xs bg-indigo-900 text-indigo-300 px-2 py-0.5 rounded ml-2">Multi</span>`
                    : `<span class="text-xs bg-gray-700 text-gray-300 px-2 py-0.5 rounded ml-2">Single</span>`;

                item.innerHTML = `
                    <div class="flex-1">
                        <div class="text-xs text-neon-blue mb-1">${q.category || 'General'}</div>
                        <div class="font-semibold text-gray-200 line-clamp-1">${q.question} ${typeBadge}</div>
                    </div>
                    <div class="flex gap-3 ml-4">
                        <button onclick="editQuestion(${index})" class="text-gray-400 hover:text-white"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="deleteQuestion(${index})" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function openQuestionModal(index = null) {
            editingQuestionIndex = index;
            const deck = decks.find(d => d.id === selectedManagerDeckId);
            const modalTitle = document.getElementById('modal-title');
            const questionText = document.getElementById('question-text');
            const optionsContainer = document.getElementById('add-options-container');
            const explanationText = document.getElementById('explanation-text');
            const codeSnippet = document.getElementById('code-snippet');
            const categoryInput = document.getElementById('category-input');

            optionsContainer.innerHTML = '';

            if (index !== null) {
                modalTitle.innerText = "Edit Question";
                const q = deck.questions[index];
                questionText.value = q.question;
                explanationText.value = q.explanation || "";
                codeSnippet.value = q.code || "";
                categoryInput.value = q.category || "General";

                // Populate Options
                q.options.forEach((opt, i) => {
                    addOptionInput(opt);
                    // Check logic: Supports both String (Single) and Array (Multi)
                    const isCorrect = Array.isArray(q.correct) 
                        ? q.correct.includes(opt) 
                        : q.correct === opt;
                    
                    if (isCorrect) {
                        document.getElementsByName('correct-opt')[i].checked = true;
                    }
                });
            } else {
                modalTitle.innerText = "Add New Question";
                questionText.value = '';
                explanationText.value = '';
                codeSnippet.value = '';
                categoryInput.value = 'General';
                addOptionInput('', true);
                addOptionInput('', false);
            }

            document.getElementById('question-modal').classList.remove('hidden');
            document.getElementById('question-modal').classList.add('flex');
        }

        function closeQuestionModal() {
            document.getElementById('question-modal').classList.add('hidden');
            document.getElementById('question-modal').classList.remove('flex');
        }

        function addOptionInput(value = '') {
            const container = document.getElementById('add-options-container');
            const div = document.createElement('div');
            div.className = "flex items-center gap-2 mb-2";
            // Use CHECKBOXES to allow multi-select
            div.innerHTML = `
                <input type="checkbox" name="correct-opt" class="w-5 h-5 text-neon-blue rounded focus:ring-0 cursor-pointer accent-neon-blue" title="Mark as correct">
                <input type="text" value="${value}" class="flex-1 bg-dark-700 text-gray-200 p-2 rounded border border-dark-700 focus:border-neon-blue outline-none" placeholder="Option text">
                <button onclick="this.parentElement.remove()" class="text-gray-500 hover:text-red-500 px-2">
                    <i class="fa-solid fa-times"></i>
                </button>
            `;
            container.appendChild(div);
        }

        function saveQuestion() {
            const text = document.getElementById('question-text').value;
            const explanation = document.getElementById('explanation-text').value;
            const code = document.getElementById('code-snippet').value;
            const category = document.getElementById('category-input').value;

            const optDivs = document.querySelectorAll('#add-options-container > div');
            const options = [];
            const correctIndices = [];

            optDivs.forEach((div, index) => {
                const input = div.querySelector('input[type="text"]');
                const checkbox = div.querySelector('input[type="checkbox"]');
                if (input.value.trim()) {
                    options.push(input.value.trim());
                    if (checkbox.checked) {
                        correctIndices.push(index);
                    }
                }
            });

            if (!text || options.length < 2 || correctIndices.length === 0) {
                showToast("Fill question, 2+ options, and select answer(s)", "error");
                return;
            }

            // POLYMORPHIC SAVE: String if single, Array if multi
            let correct;
            if (correctIndices.length === 1) {
                correct = options[correctIndices[0]];
            } else {
                correct = correctIndices.map(i => options[i]);
            }

            const deck = decks.find(d => d.id === selectedManagerDeckId);
            const newQ = {
                id: editingQuestionIndex !== null ? deck.questions[editingQuestionIndex].id : Date.now().toString(),
                question: text,
                options: options,
                correct: correct,
                explanation: explanation,
                category: category,
                code: code || null,
                dueDate: new Date(),
                interval: 0,
                ease: 2.5
            };

            if (editingQuestionIndex !== null) {
                deck.questions[editingQuestionIndex] = newQ;
                showToast("Question updated!", "success");
            } else {
                deck.questions.push(newQ);
                showToast("Question added!", "success");
            }

            saveToStorage();
            renderEditor(selectedManagerDeckId);
            closeQuestionModal();
        }

        function editQuestion(index) { openQuestionModal(index); }
        function deleteQuestion(index) {
            if (confirm("Delete this question?")) {
                const deck = decks.find(d => d.id === selectedManagerDeckId);
                deck.questions.splice(index, 1);
                saveToStorage();
                renderEditor(selectedManagerDeckId);
                showToast("Question deleted", "success");
            }
        }

        // --- QUIZ LOGIC ---
        function startQuiz(deckId) {
            currentDeckId = deckId;
            const deck = decks.find(d => d.id === deckId);
            // Filter only due cards
            quizQueue = deck.questions.filter(q => new Date(q.dueDate) <= new Date())
                                      .sort(() => Math.random() - 0.5); // Shuffle
            
            if (quizQueue.length === 0) {
                showToast("No cards due for review!", "success");
                return;
            }

            quizSessionTotal = quizQueue.length;
            showSection('quiz-section');
            renderQuestion();
        }

        function renderQuestion() {
            const container = document.getElementById('quiz-container');
            const dueCountEl = document.getElementById('due-count');
            const progBar = document.getElementById('progress-bar');
            
            currentMultiSelections = []; // Reset selections

            // Update Header
            dueCountEl.innerText = quizQueue.length;
            const progress = ((quizSessionTotal - quizQueue.length) / quizSessionTotal) * 100;
            progBar.style.width = `${progress}%`;

            if (quizQueue.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-20">
                        <h2 class="text-3xl font-bold text-white mb-4">All Caught Up! ðŸŽ‰</h2>
                        <p class="text-gray-400 mb-8">No cards due for review.</p>
                        <button onclick="showSection('decks-section')" class="px-6 py-2 bg-neon-blue text-dark-900 font-bold rounded hover:bg-blue-400 transition">
                            Back to Decks
                        </button>
                    </div>
                `;
                return;
            }

            const q = quizQueue[0];
            const isMulti = Array.isArray(q.correct);

            const codeHTML = q.code ? `<pre class="bg-dark-900 p-4 rounded-lg mb-6 overflow-x-auto text-sm text-gray-300 font-mono border border-dark-700"><code>${q.code}</code></pre>` : '';

            // Render Options
            let optionsHTML = '<div class="grid gap-3">';
            q.options.forEach(opt => {
                // Escaping quotes for JS string
                const safeOpt = opt.replace(/'/g, "\\'");
                optionsHTML += `
                    <button onclick="handleOptionClick(this, '${safeOpt}')" 
                        class="option-btn w-full text-left p-4 rounded-lg bg-dark-800 border-2 border-transparent hover:border-dark-600 transition group flex items-start gap-3 relative">
                        <div class="mt-1 w-5 h-5 rounded border border-gray-500 flex items-center justify-center group-hover:border-neon-blue transition-colors">
                            <div class="w-2.5 h-2.5 rounded-sm bg-neon-blue opacity-0 transition select-indicator"></div>
                        </div>
                        <span class="text-gray-200 leading-relaxed">${opt}</span>
                    </button>
                `;
            });
            optionsHTML += '</div>';

            const multiBadge = isMulti 
                ? `<span class="bg-indigo-900 text-indigo-200 text-xs px-2 py-1 rounded ml-2 align-middle">Select all that apply</span>` 
                : '';

            // Submit Button (only for multi)
            const submitBtn = isMulti 
                ? `<button onclick="submitMultiAnswer()" class="mt-6 w-full py-3 bg-neon-purple text-white font-bold rounded-lg hover:bg-indigo-500 transition shadow-lg shadow-indigo-500/20">Submit Answer</button>`
                : '';

            container.innerHTML = `
                <div class="max-w-2xl mx-auto animate-fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <span class="text-gray-500 text-sm">Question ${quizSessionTotal - quizQueue.length + 1} / ${quizSessionTotal}</span>
                        <span class="text-neon-blue text-sm font-mono px-2 py-1 bg-dark-800 rounded border border-dark-700">${q.category}</span>
                    </div>

                    <h2 class="text-xl md:text-2xl font-bold text-white mb-6 leading-tight">
                        ${q.question} ${multiBadge}
                    </h2>
                    
                    ${codeHTML}
                    ${optionsHTML}
                    ${submitBtn}

                    <div id="feedback-area" class="hidden mt-6 p-4 rounded-lg"></div>
                </div>
            `;
        }

        // --- ANSWER HANDLING ---
        
        function handleOptionClick(btn, optionText) {
            const q = quizQueue[0];
            const isMulti = Array.isArray(q.correct);
            const feedbackArea = document.getElementById('feedback-area');

            // Block input if already answered
            if (!feedbackArea.classList.contains('hidden')) return;

            if (isMulti) {
                // Toggle Logic
                if (currentMultiSelections.includes(optionText)) {
                    currentMultiSelections = currentMultiSelections.filter(i => i !== optionText);
                    btn.classList.remove('border-neon-blue', 'bg-dark-700');
                    btn.querySelector('.select-indicator').classList.add('opacity-0');
                } else {
                    currentMultiSelections.push(optionText);
                    btn.classList.add('border-neon-blue', 'bg-dark-700');
                    btn.querySelector('.select-indicator').classList.remove('opacity-0');
                }
            } else {
                // Single Logic: Immediate Check
                checkAnswer(optionText, btn);
            }
        }

        function submitMultiAnswer() {
            const q = quizQueue[0];
            const correctArr = q.correct;
            
            // Compare sorted arrays
            const sortedUser = [...currentMultiSelections].sort();
            const sortedCorrect = [...correctArr].sort();
            const isCorrect = JSON.stringify(sortedUser) === JSON.stringify(sortedCorrect);

            // Highlight Logic for Multi
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach(btn => {
                const btnText = btn.querySelector('span').innerText;
                
                if (correctArr.includes(btnText)) {
                    // It is a correct answer
                    btn.classList.add('border-green-500', 'bg-green-900/20');
                    btn.querySelector('div').classList.add('border-green-500', 'bg-green-500'); // Fill box
                } else if (currentMultiSelections.includes(btnText) && !correctArr.includes(btnText)) {
                    // User selected wrong
                    btn.classList.add('border-red-500', 'bg-red-900/20');
                }
            });

            processResult(isCorrect);
        }

        function checkAnswer(selectedOpt, btnElement) {
            const q = quizQueue[0];
            const isCorrect = selectedOpt === q.correct;

            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach(btn => {
                const btnText = btn.querySelector('span').innerText;
                if (btnText === q.correct) {
                    btn.classList.add('border-green-500', 'bg-green-900/20');
                    btn.querySelector('.select-indicator').classList.remove('opacity-0');
                    btn.querySelector('.select-indicator').classList.add('bg-green-400');
                } else if (btn === btnElement && !isCorrect) {
                    btn.classList.add('border-red-500', 'bg-red-900/20');
                }
            });

            processResult(isCorrect);
        }

        function processResult(isCorrect) {
            const q = quizQueue[0];
            const feedback = document.getElementById('feedback-area');
            
            // Update SR Algorithm
            updateSM2(q, isCorrect);

            feedback.className = `mt-6 p-4 rounded-lg border ${isCorrect ? 'bg-green-900/20 border-green-500 text-green-200' : 'bg-red-900/20 border-red-500 text-red-200'}`;
            feedback.innerHTML = `
                <div class="flex items-center gap-2 font-bold mb-2 text-lg">
                    <i class="fa-solid ${isCorrect ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                    ${isCorrect ? 'Correct!' : 'Incorrect'}
                </div>
                <div class="text-sm opacity-90 leading-relaxed">${q.explanation || 'No explanation provided.'}</div>
                <button onclick="nextQuestion()" class="mt-4 px-6 py-2 bg-dark-700 hover:bg-dark-600 rounded text-white text-sm font-bold transition flex items-center gap-2">
                    Continue <i class="fa-solid fa-arrow-right"></i>
                </button>
            `;
            feedback.classList.remove('hidden');
        }

        // --- SM2 ALGORITHM (Spaced Repetition) ---
        function updateSM2(card, isCorrect) {
            // Simple implementation of SuperMemo-2
            // Quality: 5=perfect, 0=complete failure
            // We simplify: Correct=4 or 5, Incorrect=1
            const quality = isCorrect ? 5 : 1;

            if (quality >= 3) {
                if (card.interval === 0) {
                    card.interval = 1;
                } else if (card.interval === 1) {
                    card.interval = 6;
                } else {
                    card.interval = Math.round(card.interval * card.ease);
                }
                card.ease = card.ease + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
                if (card.ease < 1.3) card.ease = 1.3;
            } else {
                card.interval = 0; // Reset
                card.ease = Math.max(1.3, card.ease - 0.2); // Penalty
            }

            // Set new Due Date (minutes for demo, usually days)
            // For Demo: Interval = minutes
            const nextDue = new Date();
            nextDue.setMinutes(nextDue.getMinutes() + card.interval);
            card.dueDate = nextDue;

            // Save to Deck
            const deck = decks.find(d => d.id === currentDeckId);
            const qIdx = deck.questions.findIndex(x => x.id === card.id);
            if(qIdx !== -1) deck.questions[qIdx] = card;
            saveToStorage();
        }

        function nextQuestion() {
            quizQueue.shift();
            renderQuestion();
        }

        function exitQuiz() { showSection('decks-section'); }

        // --- STORAGE ---
        function saveToStorage() {
            localStorage.setItem('neurorecall_decks', JSON.stringify(decks));
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(decks));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "neurorecall_backup.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importData(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if(Array.isArray(imported)) {
                        decks = imported;
                        saveToStorage();
                        renderDecks();
                        showToast("Decks imported successfully", "success");
                    } else {
                        showToast("Invalid JSON format", "error");
                    }
                } catch(err) {
                    showToast("Error parsing file", "error");
                }
            };
            reader.readAsText(file);
        }

        function showToast(msg, type="success") {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.className = `fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-xl transform transition-all duration-300 z-50 font-bold flex items-center gap-3 translate-y-0 opacity-100 ${type === 'success' ? 'bg-neon-green text-dark-900' : 'bg-neon-red text-white'}`;
            
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        // Start
        init();

    </script>
</body>
</html>