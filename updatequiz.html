<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Anki-Style MCQ Drill</title>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #34495e;
      --accent: #3498db;
      --success: #27ae60;
      --danger: #c0392b;
      --light: #ecf0f1;
    }

    body {
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: #dfe6e9;
      color: #2c3e50;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    .card {
      background-color: white;
      width: 100%;
      max-width: 700px;
      min-height: 440px;
      border-radius: 15px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .header {
      background-color: var(--primary);
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
      font-size: 0.9rem;
    }

    .header span.small {
      font-weight: normal;
      font-size: 0.8rem;
      opacity: 0.85;
    }

    .progress-bar-bg {
      width: 100%;
      height: 5px;
      background-color: var(--secondary);
    }

    .progress-bar-fill {
      height: 100%;
      background-color: var(--success);
      width: 0%;
      transition: width 0.3s ease;
    }

    #menu-screen {
      padding: 30px;
      text-align: center;
    }

    #menu-screen h1 {
      margin-top: 0;
    }

    select {
      padding: 10px;
      font-size: 15px;
      border-radius: 8px;
      border: 2px solid #bdc3c7;
      width: 80%;
      margin: 15px 0;
    }

    .btn-start {
      background-color: var(--accent);
      color: white;
      border: none;
      padding: 12px 30px;
      font-size: 16px;
      border-radius: 40px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .btn-start:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
    }

    #quiz-screen {
      display: none;
      flex-direction: column;
      flex-grow: 1;
      position: relative;
    }

    .content-area {
      padding: 25px 25px 10px 25px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    .question-text {
      font-size: 1.2em;
      margin-bottom: 15px;
      line-height: 1.4;
      font-weight: 600;
      color: var(--primary);
    }

    .options-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin-bottom: 10px;
    }

    .option-btn {
      background-color: white;
      border: 2px solid #bdc3c7;
      color: var(--secondary);
      padding: 10px;
      border-radius: 8px;
      text-align: left;
      cursor: pointer;
      font-size: 0.95rem;
      transition: all 0.2s;
      position: relative;
    }

    .option-btn:hover:not(:disabled) {
      border-color: var(--accent);
      background-color: #f7f9fa;
    }

    .option-btn.correct {
      background-color: #d5f5e3 !important;
      border-color: var(--success) !important;
      color: #145a32;
    }

    .option-btn.wrong {
      background-color: #fadbd8 !important;
      border-color: var(--danger) !important;
      color: #7b241c;
    }

    .option-btn:disabled {
      cursor: default;
    }

    .answer-area {
      margin-top: 6px;
      padding: 8px 10px;
      border-radius: 8px;
      background: #f4f6f7;
      border: 1px solid #e0e0e0;
      font-size: 0.9rem;
      display: none;
    }

    .answer-area strong {
      font-weight: 600;
    }

    .feedback-text {
      margin-top: 6px;
      font-size: 0.9rem;
      min-height: 18px;
    }

    .footer {
      background-color: #f8f9fa;
      padding: 10px 15px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .rating-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }

    .rating-btn {
      flex: 1;
      padding: 8px 4px;
      border-radius: 6px;
      border: none;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.1s;
    }

    .rating-btn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .rating-btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .rating-again {
      background-color: #e74c3c;
      color: #fff;
    }

    .rating-hard {
      background-color: #e67e22;
      color: #fff;
    }

    .rating-good {
      background-color: #27ae60;
      color: #fff;
    }

    .rating-easy {
      background-color: #2980b9;
      color: #fff;
    }

    .session-info {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: #7f8c8d;
    }

    .empty-state {
      padding: 40px;
      text-align: center;
    }

    .empty-state h2 {
      margin-top: 0;
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(0, 0, 0, 0.05);
    }
  </style>
</head>

<body>

  <div class="card">

    <div class="progress-bar-bg">
      <div class="progress-bar-fill" id="progress-bar"></div>
    </div>

    <div class="header" id="header" style="display:none;">
      <span>
        <span id="deck-label">Deck</span>
        <span class="small" id="due-summary"></span>
      </span>
      <span>
        <span class="small">New:</span> <span id="new-count">0</span>
        &nbsp;&nbsp;
        <span class="small">Reviews:</span> <span id="review-count">0</span>
      </span>
    </div>

    <div id="menu-screen">
      <h1>⚡ Anki-like MCQ Drill</h1>
      <p>Select your deck to begin.</p>

      <select id="deck-selector">
        <option value="all">All Questions Mixed</option>
        <option value="computing">Computing Only</option>
        <option value="os">OS</option>
        <option value="web">Web / INF1005</option>
        <option value="compnet">Computer Network</option>
      </select>

      <br>
      <button class="btn-start" onclick="startSession()">Start Session</button>
    </div>

    <div id="quiz-screen">
      <div class="content-area">
        <div class="question-text" id="q-text">Loading...</div>

        <div class="options-grid" id="opt-container"></div>

        <div class="answer-area" id="answer-area">
          <strong>Correct answer:</strong>
          <div id="answer-text"></div>
        </div>

        <div class="feedback-text" id="feedback"></div>
      </div>

      <div class="footer">
        <div class="rating-row">
          <button class="rating-btn rating-again" id="btn-again" onclick="rateCard('again')" disabled>Again</button>
          <button class="rating-btn rating-hard" id="btn-hard" onclick="rateCard('hard')" disabled>Hard</button>
          <button class="rating-btn rating-good" id="btn-good" onclick="rateCard('good')" disabled>Good</button>
          <button class="rating-btn rating-easy" id="btn-easy" onclick="rateCard('easy')" disabled>Easy</button>
        </div>
        <div class="session-info">
          <span id="position-indicator">Card 0 / 0</span>
          <span id="card-meta"></span>
        </div>
      </div>
    </div>

  </div>

  <script>
    /* --- CONFIG --- */
    const dbConfig = {
      os: "OS_questions.json",
      computing: "computing_questions.json",
      web: "web_questions.json",
      compnet: "CompNet_questions.json",
      all: ["computing_questions.json", "OS_questions.json", "web_questions.json","CompNet_questions.json"]
    };

    const NEW_INTERVAL_MINUTES = 10 / 60;
    const AGAIN_INTERVAL_MINUTES = 1 / 60;
    const HARD_MULTIPLIER = 1.2;
    const GOOD_MULTIPLIER = 2.5;
    const EASY_MULTIPLIER = 3.5;
    const MIN_INTERVAL_DAYS = 0.04;

    /* --- STATE --- */
    let deckKey = null;
    let cards = [];  // {id, question, options, answer, category, sched}
    let queue = [];  // card indices
    let currentIndexInQueue = 0;
    let answeredThisCard = false;

    function nowDays() {
      return Date.now() / (1000 * 60 * 60 * 24);
    }

    function schedulerKey(deckKey) {
      return `anki_like_mcq_state_${deckKey}`;
    }

    function loadScheduler(deckKey) {
      const raw = localStorage.getItem(schedulerKey(deckKey));
      if (!raw) return {};
      try {
        return JSON.parse(raw);
      } catch {
        return {};
      }
    }

    function saveScheduler(deckKey, state) {
      localStorage.setItem(schedulerKey(deckKey), JSON.stringify(state));
    }

    function defaultSched() {
      return {
        interval: 0,
        ease: 2.5,
        due: nowDays(),
        lapses: 0,
        reps: 0
      };
    }

    function buildCards(raw, deckKey) {
      const state = loadScheduler(deckKey);
      return raw.map((q, idx) => {
        const id = q.id || `${deckKey}_${idx}`;
        const sched = state[id] ? state[id] : defaultSched();
        return {
          id,
          question: q.question,
          options: q.options || [],
          answer: q.answer,
          category: q.category || "General",
          sched
        };
      });
    }

    function rebuildQueue() {
      const now = nowDays();
      queue = cards
        .map((c, idx) => ({ idx, card: c }))
        .filter(({ card }) => card.sched.due <= now + 1e-6)
        .sort((a, b) => a.card.sched.due - b.card.sched.due)
        .map(x => x.idx);
      currentIndexInQueue = 0;
    }

    function startSession() {
      const selector = document.getElementById('deck-selector');
      deckKey = selector.value;
      const files = dbConfig[deckKey];
      const list = Array.isArray(files) ? files : [files];

      Promise.all(
        list.map(file =>
          fetch(file)
            .then(r => (r.ok ? r.json() : []))
            .catch(() => [])
        )
      ).then(results => {
        const all = results.flat();
        if (!all.length) {
          alert("No questions found! Check JSON files.");
          return;
        }

        shuffleArray(all);
        cards = buildCards(all, deckKey);
        rebuildQueue();

        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('quiz-screen').style.display = 'flex';
        document.getElementById('header').style.display = 'flex';

        document.getElementById('deck-label').innerText =
          deckKey === 'all' ? 'All Decks' : deckKey.toUpperCase();

        if (!queue.length) {
          renderEmptyState();
        } else {
          loadCurrentCard();
        }
        updateHeader();
      });
    }

    function renderEmptyState() {
      const quiz = document.getElementById('quiz-screen');
      quiz.innerHTML = `
        <div class="empty-state">
          <h2>No cards due</h2>
          <p>You've cleared everything that is currently due in this deck.</p>
          <p><span class="pill">Come back later for more reviews.</span></p>
          <button class="btn-start" onclick="location.reload()">Return to Menu</button>
        </div>
      `;
    }

    function loadCurrentCard() {
      if (!queue.length) {
        renderEmptyState();
        return;
      }

      const cardIndex = queue[currentIndexInQueue];
      const card = cards[cardIndex];

      answeredThisCard = false;
      setRatingButtonsEnabled(false);

      const qEl = document.getElementById('q-text');
      const optContainer = document.getElementById('opt-container');
      const ansArea = document.getElementById('answer-area');
      const ansText = document.getElementById('answer-text');
      const feedback = document.getElementById('feedback');

      qEl.innerText = card.question;
      optContainer.innerHTML = '';
      feedback.innerText = '';
      feedback.style.color = '';
      ansArea.style.display = 'none';
      ansText.innerText = card.answer;

      card.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.innerText = opt;
        btn.onclick = () => handleAnswer(btn, idx, card);
        optContainer.appendChild(btn);
      });

      const pos = `${currentIndexInQueue + 1} / ${queue.length}`;
      document.getElementById('position-indicator').innerText = `Card ${pos}`;

      const s = card.sched;
      const intervalText = s.interval === 0 ? 'New' : `${s.interval.toFixed(2)} d`;
      document.getElementById('card-meta').innerText =
        `${card.category} • Int: ${intervalText} • Reps: ${s.reps}`;
    }

    function handleAnswer(clickedBtn, idx, card) {
      if (answeredThisCard) return;
      answeredThisCard = true;

      const buttons = document.querySelectorAll('.option-btn');
      buttons.forEach(btn => {
        btn.disabled = true;
        if (btn.innerText === card.answer) btn.classList.add('correct');
      });

      const isCorrect = clickedBtn.innerText === card.answer;
      if (!isCorrect) {
        clickedBtn.classList.add('wrong');
      }

      const fb = document.getElementById('feedback');
      fb.innerText = isCorrect ? "Correct!" : "Incorrect";
      fb.style.color = isCorrect ? "var(--success)" : "var(--danger)";

      document.getElementById('answer-area').style.display = 'block';
      setRatingButtonsEnabled(true);
    }

    function setRatingButtonsEnabled(enabled) {
      ['btn-again', 'btn-hard', 'btn-good', 'btn-easy'].forEach(id => {
        document.getElementById(id).disabled = !enabled;
      });
    }

    function rateCard(rating) {
      if (!queue.length || !answeredThisCard) return;

      const cardIndex = queue[currentIndexInQueue];
      const card = cards[cardIndex];

      applyScheduling(card, rating);
      persistCard(card);

      queue.splice(currentIndexInQueue, 1);
      if (currentIndexInQueue >= queue.length) {
        currentIndexInQueue = queue.length - 1;
      }
      updateHeader();

      if (!queue.length) {
        renderEmptyState();
      } else {
        if (currentIndexInQueue < 0) currentIndexInQueue = 0;
        loadCurrentCard();
      }
    }

    function applyScheduling(card, rating) {
      const now = nowDays();
      const s = card.sched;
      s.reps += 1;

      if (s.interval === 0) {
        if (rating === 'again') {
          s.interval = AGAIN_INTERVAL_MINUTES / (60 * 24);
        } else if (rating === 'hard') {
          s.interval = Math.max(MIN_INTERVAL_DAYS, NEW_INTERVAL_MINUTES * 0.5);
        } else if (rating === 'good') {
          s.interval = Math.max(MIN_INTERVAL_DAYS, NEW_INTERVAL_MINUTES);
        } else if (rating === 'easy') {
          s.interval = Math.max(MIN_INTERVAL_DAYS, NEW_INTERVAL_MINUTES * 2.0);
        }
      } else {
        if (rating === 'again') {
          s.lapses += 1;
          s.interval = MIN_INTERVAL_DAYS;
          s.ease = Math.max(1.3, s.ease - 0.2);
        } else if (rating === 'hard') {
          s.interval = Math.max(MIN_INTERVAL_DAYS, s.interval * HARD_MULTIPLIER);
          s.ease = Math.max(1.3, s.ease - 0.05);
        } else if (rating === 'good') {
          s.interval = Math.max(MIN_INTERVAL_DAYS, s.interval * GOOD_MULTIPLIER * s.ease / 2.5);
        } else if (rating === 'easy') {
          s.interval = Math.max(MIN_INTERVAL_DAYS, s.interval * EASY_MULTIPLIER * s.ease / 2.5);
          s.ease = Math.min(3.0, s.ease + 0.05);
        }
      }

      s.due = now + s.interval;
    }

    function persistCard(card) {
      const state = loadScheduler(deckKey);
      state[card.id] = card.sched;
      saveScheduler(deckKey, state);
    }

    function updateHeader() {
      if (!cards.length) return;

      const now = nowDays();
      const newCount = cards.filter(c => c.sched.reps === 0 && c.sched.due <= now + 1e-6).length;
      const reviewCount = cards.filter(c => c.sched.reps > 0 && c.sched.due <= now + 1e-6).length;

      document.getElementById('new-count').innerText = newCount;
      document.getElementById('review-count').innerText = reviewCount;

      const totalDue = newCount + reviewCount;
      document.getElementById('due-summary').innerText = `• Due: ${totalDue}`;

      const totalCards = cards.length;
      const done = Math.max(0, totalCards - totalDue);
      const percent = totalCards === 0 ? 0 : (done / totalCards) * 100;
      document.getElementById('progress-bar').style.width = `${percent}%`;
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }
  </script>

</body>

</html>
